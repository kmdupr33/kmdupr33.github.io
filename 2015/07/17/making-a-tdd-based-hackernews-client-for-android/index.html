<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
  />
  <link
    href="/css/all.min.css"
    rel="stylesheet"
    />
  <style>
    #content {
      font-size: 18px;
      line-height: 1.7;
    }
    #content img {
      max-width: 100%;
    }
    #mc_embed_signup label {
      color: white;
    }
    #mc_embed_signup input.email {
      color: white;
      border-color: white;
    }

    #mc_embed_signup input.button {
      background-color: #ee6e73;
    }
    .rc-scout .rc-scout__link:link {
      color: white;
    }
    .browser-default-uls ul {
      padding-left: 30px;
      margin-top: 10px;
      margin-bottom: 15px;
    }
    .browser-default-uls ul > li {
      list-style-type: disc!important;
    }
    pre {
      overflow: auto;
      padding: 15px;
    }
  </style>
  <title>Philosophical Hacker</title>
</head>
<body><nav>
  <div class="nav-wrapper green">
    <a
      href="/"
      class="brand-logo"
      style="margin-left: 10px;"
      >Philosophical Hacker</a
    >
    <a href="#" data-target="mobile-demo" class="sidenav-trigger"
      ><i class="material-icons">menu</i></a
    >
    <ul class="right hide-on-med-and-down">      
      <li><a href="/about/me">About</a></li>
      
      <li><a href="/note">Notes</a></li>
      <li>
        <a
          href="https://www.oreilly.com/library/view/~/9781492048343/?intcmp=il-prog-free-product-na_new_site_rxjava_for_android_app_development"
          >RxJava O'Reilly Ebook</a
        >
      </li>
      <li>
          <a href="https://twitter.com/philosohacker"
            ><i class="fab fa-twitter"></i
          ></a>
        </li>
        <li>
          <a href="https://www.linkedin.com/in/k-matthew-dupree-44672178/"
            ><i class="fab fa-linkedin-in"></i
          ></a>
        </li>
    </ul>
  </div>
  <ul class="sidenav" id="mobile-demo">    
    <li><a href="/about/me">About</a></li>
    
    <li><a href="/note">Notes</a></li>
    <li>
      <a
        href="https://www.oreilly.com/library/view/~/9781492048343/?intcmp=il-prog-free-product-na_new_site_rxjava_for_android_app_development"
        >Rx Java O'Reilly Ebook</a
      >
    </li>
    <li>
        <a href="https://twitter.com/philosohacker"
          ><i class="fab fa-twitter"></i
        ></a>
      </li>
      <li>
        <a href="https://www.linkedin.com/in/k-matthew-dupree-44672178/"
          ><i class="fab fa-linkedin-in"></i
        ></a>
      </li>
  </ul>
</nav>
<div id="content" class="browser-default-uls">

<div class="row">
  <div class="col s12 m6 offset-m3">
      <section id="main">          
          <h1 id="title">Making a TDD-based HackerNews client for Android</h1>
          <p id="date"> Fri Jul 17, 2015 | 4 Minute read </p>
          <div>
                <article id="content">
                   <p>I&rsquo;m using TDD to write a HackerNews client for Android. This post (and the ones that will likely follow it) share a little bit about some of the techniques I used to follow a TDD-based work-flow for developing this application. It also discusses the architecture that arises when Android apps are built with testability in mind from the ground up.</p>

<h2 id="testing-a-walking-skeleton">Testing a Walking Skeleton</h2>

<p>The first step in kick-starting a TDD workflow, according to Steve Freeman and Nat Pryce in <em>Growing Object Oriented Software Guided by Tests</em>, is to &ldquo;test a walking skeleton.&rdquo; A walking skeleton, as they define it, is this:</p>

<blockquote>A “walking skeleton” is an implementation of the thinnest possible slice of real functionality that we can automatically build, deploy, and test end-to-end.

pg. 69-70</blockquote>

<p>A walking skeleton for a HackerNews client, as I see it, should just display a list of HackerNews story ids. To implement this test, I use a simple espresso test that looks like this:</p>

<script type="application/javascript" src="https://gist.github.com/kmdupr33/a25db0930e583db05535.js"></script>


<h3 id="how-i-got-consistent-test-data">How I Got Consistent Test Data</h3>

<p>Here&rsquo;s a question that arose immediately when writing this test: How can we ensure that the MainActivity was fetching the same data for every test run so that the value 9897306 that we&rsquo;re checking against is always appropriate. <a href="https://www.google.com/webhp?sourceid=chrome-instant&amp;ion=1&amp;espv=2&amp;ie=UTF-8#q=jake%20wharton%20dagger%20parley">Jake Wharton&rsquo;s discussion</a> on Dagger modules that can override the dependencies that are injected into your Android objects came to mind here, so I decided to use this approach to ensure that the data the test uses is always the same.</p>

<p>Let me briefly describe how I used this approach in my application.</p>

<p>Objects in PhilHackerNews access the Dagger object graph from the <code>PhilHackerNewsApplication</code> subclass. That class is responsible for making the <code>ObjectGraph</code>:</p>

<script type="application/javascript" src="https://gist.github.com/kmdupr33/eb4565747da03d9f1309.js"></script>


<p>So, when I&rsquo;m running a test, I use a custom test runner that creates a subclass of <code>PhilHackerNewsApplication</code> to create the <code>ObjectGraph</code> with the overridden module:</p>

<script type="application/javascript" src="https://gist.github.com/kmdupr33/d8a344157014e3cf0c8a.js"></script>


<p>The <code>TestApplication</code> class creates the <code>ObjectGraph</code> with a module that overrides the dependencies responsible for fetching HackerNews data:</p>

<script type="application/javascript" src="https://gist.github.com/kmdupr33/36c1e516b335092057c2.js"></script>


<p><code>TestLoaderModule</code> is the module that provides the overridden dependency. It provides a HackerNewsRestAdapter that simply loads HackerNews data from memory instead of the server:</p>

<h3 id="the-current-state-of-app-s-architecture">The Current State of App&rsquo;s Architecture</h3>

<p>Let me point out a few things about the architecture needed to get this test to pass. First off, I want to say that this architecture is likely to change for the same reasons that Pryce and Freeman point out:</p>

<blockquote>[When testing a walking skeleton, w]e’re not trying to elaborate the whole design down to classes and algorithms before we start coding. Any ideas we have now are likely to be wrong, so we prefer to discover those details as we grow the system.

Pg. 73</blockquote>

<p>Here&rsquo;s something interesting about the state of the architecture currently: it uses a combination of RxJava and Loaders to ensure that</p>

<ul>
<li><p>The network calls are made and delivered properly even if the MainActivity and its Fragment are destroyed because of a configuration change</p></li>

<li><p>The classes in the &ldquo;Application Layer&rdquo; of this app are freed from having to worry about the Android-specific problem of asynchronous data loading for app components that can be destroyed and recreated at any time.</p></li>
</ul>

<p>The inspiration for this decision comes from Freeman and Pryce&rsquo;s advice:</p>

<blockquote>We don’t want technical concepts to leak into the application model, so we write interfaces to describe its relationships with the outside world in its terminology (Cockburn’s ports ). Then we write bridges between the application core and each technical domain (Cockburn’s adapters ).

Pg. 90</blockquote>

<p>The problem that Loaders attempt to solve, as I see it, is a technical one that doesn&rsquo;t belong in the Application Layer. To shield application layer objects from this technical detail, I&rsquo;ve created and pass around an Observable that, upon subscription, initializes a load from a Loader using a LoaderManager:</p>

<script type="application/javascript" src="https://gist.github.com/kmdupr33/c6c1641ed1a24e07e062.js"></script>


<p>Rather than dealing with loaders directly, clients that want to consume the &ldquo;loaded&rdquo; data subscribe to the <code>Observable</code> that&rsquo;s created with a <code>LoaderInitializingOnSubscribe</code>. In my application, Activities/Fragments/Presenters will not interact with this Observable directly, however. Instead, they&rsquo;ll interact with a StoryRepository that will (eventually) be responsible for deciding whether data gets loaded from the cache or from the network. Here&rsquo;s what that class looks like at the moment:</p>

<script type="application/javascript" src="https://gist.github.com/kmdupr33/378997639d5bac95a392.js"></script>


<p>And here&rsquo;s a relevant snippet of the Fragment that uses this class to load the HackerNews data:</p>

<script type="application/javascript" src="https://gist.github.com/kmdupr33/fb1c638f2fdbe6a8bd68.js"></script>


<p>If you want to have a closer look at what I&rsquo;ve done, feel free to take a look at <a href="https://github.com/kmdupr33/PhilHackerNews">the repo for this project</a>.</p>
                </article>
          </div>
        </section>                
  </div>
  
</div>
<footer class="page-footer green text-white">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
            
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<div id="mc_embed_signup">
<form action="//appspot.us11.list-manage.com/subscribe/post?u=9612e1a3261cb5689813bf38b&amp;id=0c5f737d6c" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<label for="mce-EMAIL">Get Email Updates</label>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9612e1a3261cb5689813bf38b_0c5f737d6c" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>


            <div class="rc-scout" style="text-align: center;"></div>    
        </div>
        <aside id="meta">            
            <div>
                
                <div>                  
                  <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/2015/07/14/why-static-references-to-application-contexts-are-probably-not-the-best-idea/">Previous: Why Having Global Static References to Application Contexts is Probably not the Best Idea</a>
                </div>
                
                
                <div>                  
                  <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/2016/01/13/should-we-use-mocking-libraries-for-go-testing/">Next: Should we use mocking libraries for go testing?</a>
                </div>
                
            </div>
        </aside>  
        <div class="col l4 offset-l2 s12">
          <h5 class="white-text">Tags</h5>
          <ul>              
              
              <ul id="tags">
                
                  <li> <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/tags/android">android</a> </li>
                
                  <li> <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/tags/testing">testing</a> </li>
                
              </ul>
                          
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-copyright">
      <div class="container">
      © 2019 Matt Dupree
      </div>
    </div>    
  </footer>        


        </div><script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var elems = document.querySelectorAll(".sidenav");
    var instances = M.Sidenav.init(elems, {});
  });
</script>
<script async defer src="https://www.recurse-scout.com/loader.js?t=b7a91d718a76fe21289fbe7d51a58f19"></script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-63544399-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>
</html>
