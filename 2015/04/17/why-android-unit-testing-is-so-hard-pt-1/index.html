<!DOCTYPE html>
<html lang="en-us">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  	<meta property="og:title" content=" Why Android Unit Testing is so Hard (Pt 1) &middot;  Philosophical Hacker" />
  	<meta property="og:site_name" content="Philosophical Hacker" />
  	<meta property="og:url" content="http://kmdupr33.github.io/2015/04/17/why-android-unit-testing-is-so-hard-pt-1/" />

    
  	<meta property="og:type" content="article" />

    <meta property="og:article:published_time" content="2015-04-17T13:46:58Z" />

    
    

  <title>
     Why Android Unit Testing is so Hard (Pt 1) &middot;  Philosophical Hacker
  </title>

    <meta name="description" content="Articles on android and go development" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="http://kmdupr33.github.io/images/favicon.ico">
	  <link rel="apple-touch-icon" href="http://kmdupr33.github.io/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="http://kmdupr33.github.io/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="http://kmdupr33.github.io/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:400,700,700italic,400italic|Open+Sans:700,400|Inconsolata" />


    
      
          <link href="http://kmdupr33.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Philosophical Hacker" />
      
      
    
    <meta name="generator" content="Hugo 0.15" />

    <link rel="canonical" href="http://kmdupr33.github.io/2015/04/17/why-android-unit-testing-is-so-hard-pt-1/" />

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-63544399-1', 'auto');
      ga('send', 'pageview');

    </script>
    

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/">Home</a>
            </li>
        
    </ul>
    
    
    <a class="subscribe-button icon-feed" href="http://kmdupr33.github.io/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">




<header class="main-header post-head no-cover">
  <nav class="main-nav clearfix">


  
  
      <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">Why Android Unit Testing is so Hard (Pt 1)</h1>
        <small></small>

        <section class="post-meta">
        
          <time class="post-date" datetime="2015-04-17T13:46:58Z">
            Apr 17, 2015
          </time>
        
         
        </section>
    </header>

    <section class="post-content">
      

<p><strong>Edit:</strong> In <a href="http://philosophicalhacker.com/2015/05/22/what-ive-learned-from-trying-to-make-an-android-app-unit-testable/">the post that concludes this series</a>, I point out that making unit testable Android apps does not require us to remove compile-time dependencies on the Android SDK and that attempting to do so is impractical anyway. Ignore anything in this post that suggests otherwise.</p>

<hr />

<p>Unit testing your Android apps can be extremely difficult. As I suggested in <a href="http://philosophicalhacker.com/2015/04/10/against-android-unit-tests/">the introduction to this series,</a> it seems clear that there’s widespread agreement on this. The many folks who responded to my introductory post, moreover, seemed to reinforce my claim that Android unit testing is tough:</p>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">What he said! RT <a href="https://twitter.com/philosohacker">@philosohacker</a>: New post on how we can better test our Android apps <a href="http://t.co/gQCJKIOrSN">http://t.co/gQCJKIOrSN</a></p>&mdash; Andy Dyer (@dammitandy) <a href="https://twitter.com/dammitandy/status/587629744188829699">April 13, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr"><a href="https://twitter.com/corey_latislaw">@corey_latislaw</a> Yay! Maybe I can finally figuring out how to test Android apps properly. Also, this. <a href="http://t.co/8gIqfoFVnL">http://t.co/8gIqfoFVnL</a></p>&mdash; Vinay Shenoy (@vinaysshenoy) <a href="https://twitter.com/vinaysshenoy/status/587608070131290112">April 13, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Fully agree: &quot;Against Android Unit Tests&quot;. Structure your code to have as little contact with the SDK as possible. <a href="http://t.co/rLZlpGrCD5">http://t.co/rLZlpGrCD5</a></p>&mdash; Pascal Hartig (@passy) <a href="https://twitter.com/passy/status/587336731260751875">April 12, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>So, Android unit testing is hard. That much is clear. Why Android unit testing is so difficult, however, is less clear. Its true that a part of the difficulty with Android unit testing has to do with the nonsense that you have to overcome to get Roboletric started so that you can run your tests at a decent speed, but I think that there’s a deeper reason why we are having a hard time testing our applications: the way that Google has written the Android SDK and the way that Google encourages us to structure our applications makes testing difficult and, in some cases, impossible.</p>

<p>I realize that this is a bold claim, so I will spend the entire post trying to establish it. In the following post, I’ll try to say more about how the “standard” way of developing Android applications encourages us to write code that is difficult/impossible to write sensible unit tests against. These posts are a part of a series in which I’m exploring the viability of enhancing the testability of Android applications by restructuring them so that application code does not directly depend on the Android SDK. Showing why the standard architecture for Android development makes testing difficult will both motivate and inform my alternative proposal for structuring Android applications, a proposal that I will outline in the fourth post of the series.</p>

<h1 id="a-seemingly-simple-test-case:bcd0589be09168661f8a882293fec890">A (Seemingly) Simple Test Case</h1>

<p>To see why unit testing in Android is so difficult, let’s start by looking at a simple test case. I’ll be using source code from Google’s IOsched app because, as I pointed out in my first post, that app is supposed to serve as a model for Android developers.</p>

<p>The IOsched app has a IO session detail screen that looks like this:</p>

<p><a href="http://www.philosophicalhacker.com/wp-content/uploads/2015/04/screenshot-0646am-apr-17-2015.png"><img src="http://www.philosophicalhacker.com/wp-content/uploads/2015/04/screenshot-0646am-apr-17-2015.png?w=169" alt="Screenshot (06:46AM, Apr 17, 2015)" /></a></p>

<p>Notice that the detail screen has a “+” button that allows users to add the session to their calendar. That plus button turns to a “check” button if they’ve added the session to their calendar. If they tap the “check” button again, the session will be removed from their calendar. The state of the button is (confusingly) stored in an instance variable called mStarred, so depending on the state of this button, the Activity will launch a Service that adds or removes that session to the user’s calendar in its onStop() method:</p>

<script src="//gist.github.com/kmdupr33/4c90e155dcaf6c4e0147.js"></script>

<p>This seems like a sensible piece of code to write a unit test against. Here’s the problem: you <em>can’t</em> write a unit test against this code. In order to see why, we’ll have to take a step back from Android and think a bit about what makes code testable in general.</p>

<p>The three steps of a unit test, as we all know, are arrange, act, and assert. In order to successfully perform the assert-step in our test, we need access to <em>the state of our program that was changed as a result of the code executed in the act-step of the test</em>. Let’s call this state the “post-act-state.” For unit tests, there’s only three ways that we can access the post-act-state.</p>

<p>The first way we can access the post-act-state is to check the return value of the method that executed during the act-step of the test. Writing tests against these methods is easy:</p>

<script src="//gist.github.com/kmdupr33/0446675a4accb8b4fcf1.js"></script>

<p>The second way to get a handle on your post-act-state is to get a reference to some publicly accessible property of the object being tested, and to assert that the state of that property is what you expect:</p>

<script src="//gist.github.com/kmdupr33/830046fbad2aca2b9531.js"></script>

<p>The final way to assert that your post-act-state meets your expectations is check the state of the object’s injected dependencies. These dependencies may not be publicly accessible, but because you inject them during your test method, you have a reference to them:</p>

<script src="//gist.github.com/kmdupr33/03c9e003d2c3c7649297.js"></script>

<p>Now that we’ve listed all of the ways that we can complete the assert-step of a unit test, we’re in a position to see why the above Android code is untestable: there’s simply no way for us to complete the assert-step of a unit test against the <code>onStop()</code> method. <code>onStop()</code> doesn’t have a return value. There’s no publicly accessible property of <code>SessionDetailActivity</code> that will help us verify that the <code>SessionCalendarService</code> has been launched with the correct instructions. Finally, the code that launches the <code>SessionCalendarService</code> is not code that belongs to a dependency that’s been injected into <code>SessionDetailActivity</code>.</p>

<p>Unfortunately, it gets worse than this. It is also impossible to complete the arrange-step of a unit-test for <code>onStop()</code>. In order to complete the arrange-step of a unit test, you must be able to alter any conditions that affect the post-act-state of your program. I will call these conditions “pre-act-state.” Since there’s no way to change the pre-act-state for <code>onStop()</code>, we can’t unit test it.</p>

<p>The pre-act-state within <code>onStop()</code> is the mInitStarred boolean. Again, here’s the source for <code>onStop()</code>:</p>

<script src="//gist.github.com/kmdupr33/4c90e155dcaf6c4e0147.js"></script>

<p>This boolean is set in a callback method that’s executed after a <code>ContentProvider</code> query has completed:</p>

<script src="//gist.github.com/kmdupr33/325d480ee63848412748.js"></script>

<p>There’s a reason <code>mInitStarred</code> is initialized in a Loader callback. If a user adds a session to their calendar and navigates away from the <code>SesssionDetailActivity</code>, the flag indicating whether the session is a part of a user’s calendar is stored in a database table containing IO Sessions. As we all know, Google wants us to use Loaders to get data from a database, so <code>mInitStarred</code> gets initialized in a <code>Loader</code> callback.¹</p>

<p><code>mInitStarred</code> is used to determine whether its actually necessary to launch a <code>SessionCalendarService</code> to update the user’s calendar to include or exclude a particular session. If the database tells us that a session is already a part of a user’s calendar and if the state of the plus button indicates that that’s what the user wants when they leave the <code>SessionDetailActivity</code>, then we don’t need to do anything.</p>

<p>So, if we’re testing <code>onStop()</code>, we want to make sure that it launches a Service that updates the user’s calendar according to the state of the plus button <em>only if</em> necessary. Unfortunately, because <code>mInitStarred</code> is a private instance variable that’s initialized in a Loader callback, there is simply no way for us to change the value of mInitStarred from a unit test method. Again, to see this, let’s think through the ways that we alter an object’s pre-act-state state for a unit test.</p>

<p>The first way is to alter a publicly accessible property that affects the object’s pre-act-state:²</p>

<script src="//gist.github.com/kmdupr33/5979104560afac8b525d.js"></script>

<p>The second way is to change the parameters passed in to the method being tested:</p>

<script src="//gist.github.com/kmdupr33/ea00e4e2e2489a965317.js"></script>

<p>Again, neither of these two options are available to us, so we can’t even complete the arrange-step of a unit test for <code>onStop()</code>. There is no publicly accessible property on <code>SeessionDetailActivity</code> that we can set to alter the value of <code>mInitStarred</code>. <code>onStop()</code>, moreover, doesn&rsquo;t take <code>mInitStarred</code> as a parameter, so we can&rsquo;t modify the pre-act-state by changing <code>onStop()</code>&rsquo;s parameter value either.</p>

<h1 id="conclusion:bcd0589be09168661f8a882293fec890">Conclusion</h1>

<p>So, a piece of code that seems like it should be easy to unit test, turns out to be impossible to test. If you’ve ever found yourself staring at <code>Activity</code> for hours trying to figure how to unit test some of its business logic, this is why: In many cases, it’s just not possible. It some cases, it may be impossible to complete the arrange-step of a test because you have no way of altering the test object’s pre-act-state. In other cases, you may not be able to complete the assert-step of your test because you can’t access relevant post-act-state. <code>onStop()</code> in <code>SessionDetailActivity</code> suffers from both of these problems.</p>

<p>There is plenty of Android code that is simply untestable. I think that the way we structure our applications, along with some special properties of Android platform, set us on a path to writing un-testable code. In <a href="http://philosophicalhacker.com/2015/04/24/why-android-unit-testing-is-so-hard-pt-2/">the next post</a>, I’ll elaborate on this claim.</p>

<p><strong>Notes:</strong></p>

<ol>
<li><p>They push Loaders pretty hard in <a href="https://www.youtube.com/watch?v=qrPoIF6A9gM">one of their videos for the Udacity course on Android Development</a>.</p></li>

<li><p>Clearly there’s multiple ways of doing this. If, for example, the pre-act-state is determined by a dependency of the object being tested, we can also modify pre-act-state by changing the dependency’s public property.</p></li>
</ol>

    </section>


  <footer class="post-footer">


    

    





<section class="author">
  <h4><a href="http://kmdupr33.github.io/"></a></h4>
  
  <p>Read <a href="http://kmdupr33.github.io/">more posts</a> by this author.</p>
  
  <div class="author-meta">
    
    
  </div>
</section>



    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=Why%20Android%20Unit%20Testing%20is%20so%20Hard%20%28Pt%201%29&amp;url=http%3a%2f%2fkmdupr33.github.io%2f2015%2f04%2f17%2fwhy-android-unit-testing-is-so-hard-pt-1%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fkmdupr33.github.io%2f2015%2f04%2f17%2fwhy-android-unit-testing-is-so-hard-pt-1%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-pinterest" style="font-size: 1.4em" href="http://pinterest.com/pin/create/button/?url=http%3a%2f%2fkmdupr33.github.io%2f2015%2f04%2f17%2fwhy-android-unit-testing-is-so-hard-pt-1%2f&amp;description=Why%20Android%20Unit%20Testing%20is%20so%20Hard%20%28Pt%201%29"
      onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
      <span class="hidden">Pinterest</span>
  </a>
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=http%3a%2f%2fkmdupr33.github.io%2f2015%2f04%2f17%2fwhy-android-unit-testing-is-so-hard-pt-1%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



    

<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'philosophicalhacker';
  var disqus_url = 'http:\/\/kmdupr33.github.io\/2015\/04\/17\/why-android-unit-testing-is-so-hard-pt-1\/';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




  </footer>
</article>

</main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Philosophical Hacker</a> </section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="http://kmdupr33.github.io/js/jquery.js"></script>
    <script type="text/javascript" src="http://kmdupr33.github.io/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="http://kmdupr33.github.io/js/index.js"></script>
    
</body>
</html>

