<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
  />
  <link
    href="/css/all.min.css"
    rel="stylesheet"
    />
  <style>
    #content {
      font-size: 18px;
      line-height: 1.7;
    }
    #content img {
      max-width: 100%;
    }
    #mc_embed_signup label {
      color: white;
    }
    #mc_embed_signup input.email {
      color: white;
      border-color: white;
    }

    #mc_embed_signup input.button {
      background-color: #ee6e73;
    }
    .rc-scout .rc-scout__link:link {
      color: white;
    }
    .browser-default-uls ul {
      padding-left: 30px;
      margin-top: 10px;
      margin-bottom: 15px;
    }
    .browser-default-uls ul > li {
      list-style-type: disc!important;
    }
    pre {
      overflow: auto;
      padding: 15px;
    }
  </style>
  <title>Philosophical Hacker</title>
</head>
<body><nav>
  <div class="nav-wrapper green">
    <a
      href="/"
      class="brand-logo"
      style="margin-left: 10px;"
      >Philosophical Hacker</a
    >
    <a href="#" data-target="mobile-demo" class="sidenav-trigger"
      ><i class="material-icons">menu</i></a
    >
    <ul class="right hide-on-med-and-down">      
      <li><a href="/about/me">About</a></li>
      
      <li><a href="/note">Notes</a></li>
      <li>
        <a
          href="https://www.oreilly.com/library/view/~/9781492048343/?intcmp=il-prog-free-product-na_new_site_rxjava_for_android_app_development"
          >RxJava O'Reilly Ebook</a
        >
      </li>
      <li>
          <a href="https://twitter.com/philosohacker"
            ><i class="fab fa-twitter"></i
          ></a>
        </li>
        <li>
          <a href="https://www.linkedin.com/in/k-matthew-dupree-44672178/"
            ><i class="fab fa-linkedin-in"></i
          ></a>
        </li>
    </ul>
  </div>
  <ul class="sidenav" id="mobile-demo">    
    <li><a href="/about/me">About</a></li>
    
    <li><a href="/note">Notes</a></li>
    <li>
      <a
        href="https://www.oreilly.com/library/view/~/9781492048343/?intcmp=il-prog-free-product-na_new_site_rxjava_for_android_app_development"
        >Rx Java O'Reilly Ebook</a
      >
    </li>
    <li>
        <a href="https://twitter.com/philosohacker"
          ><i class="fab fa-twitter"></i
        ></a>
      </li>
      <li>
        <a href="https://www.linkedin.com/in/k-matthew-dupree-44672178/"
          ><i class="fab fa-linkedin-in"></i
        ></a>
      </li>
  </ul>
</nav>
<div id="content" class="browser-default-uls">

    <img style="filter: brightness(.4); width: 100%;" src="/images/broken-brick.jpg"/>

<div class="row">
  <div class="col s12 m6 offset-m3">
      <section id="main">          
          <h1 id="title">Test Driving away Coupling in Activities</h1>
          <p id="date"> Sun Apr 9, 2017 | 6 Minute read </p>
          <div>
                <article id="content">
                   

<p><code>Activity</code>s and <code>Fragment</code>s, perhaps by <a href="/post/why-android-testing-is-so-hard-historical-edition/">some strange historical accidents</a>, have been seen as <em>the optimal</em> building blocks upon which we can build our Android applications for much of the time that Android has been around. Let&rsquo;s call this idea &ndash; the idea that <code>Activity</code>s and <code>Fragment</code>s are the best building blocks for our apps &ndash; &ldquo;android-centric&rdquo; architecture.</p>

<p>This series of posts is about the connection between the testability of android-centric architecture and the other problems that are now leading Android developers to reject it; it&rsquo;s about how our unit tests are trying to tell us that <code>Activity</code>s and <code>Fragment</code>s &ndash; like the cracking bricks in the above image &ndash; don&rsquo;t make the best building blocks for our apps because they tempt us to write code with <em>tight coupling</em> and <em>low cohesion</em>.</p>

<hr />

<p><a href="/post/what-unit-tests-are-trying-to-tell-us-about-activities-pt-2/">Last time</a>, we saw <code>Activity</code>s and <code>Fragment</code>s tend to have low cohesion. This time, we&rsquo;ll see how our tests can tell us that code within <code>Activity</code>s have tight coupling. We&rsquo;ll also see how test driving the functionality leads to a design that has looser coupling, which makes it easier to change the app and also opens up opportunities for removing duplication. As with the the other posts in the series, we&rsquo;ll be discussing all of this using the Google I/O app as an example.</p>

<h3 id="the-target-code">The Target Code</h3>

<p>The code that we want to test, the &ldquo;target code&rdquo;, does the following: when the user navigates to the map view that shows where all the Google I/O sessions are, it asks for their location. If they reject the permission, we show a toast notifying the user that they&rsquo;ve disabled an app permission. Here&rsquo;s a screenshot of this:</p>

<p><img src="/images/permission-denied-toast.png" alt="permission denied toast" /></p>

<p>Here&rsquo;s the code that accomplishes this:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Override
<span style="color:#fff;font-weight:bold">public</span> void onRequestPermissionsResult(<span style="color:#fff;font-weight:bold">final</span> int requestCode,
        @NonNull <span style="color:#fff;font-weight:bold">final</span> String[] permissions,
        @NonNull <span style="color:#fff;font-weight:bold">final</span> int[] grantResults) {

    <span style="color:#fff;font-weight:bold">if</span> (requestCode != REQUEST_LOCATION_PERMISSION) {
        <span style="color:#fff;font-weight:bold">return</span>;
    }

    <span style="color:#fff;font-weight:bold">if</span> (permissions.<span style="color:#007f7f">length</span> == 1 &amp;&amp;
            LOCATION_PERMISSION.<span style="color:#007f7f">equals</span>(permissions[0]) &amp;&amp;
            grantResults[0] == PackageManager.<span style="color:#007f7f">PERMISSION_GRANTED</span>) {
        <span style="color:#007f7f">// Permission has been granted.
</span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (mMapFragment != <span style="color:#fff;font-weight:bold">null</span>) {
            mMapFragment.<span style="color:#007f7f">setMyLocationEnabled</span>(<span style="color:#fff;font-weight:bold">true</span>);
        }
    } <span style="color:#fff;font-weight:bold">else</span> {
<span style="display:block;width:100%;background-color:#191919">        <span style="color:#007f7f">// Permission was denied. Display error message.
</span></span><span style="display:block;width:100%;background-color:#191919"><span style="color:#007f7f"></span>        Toast.<span style="color:#007f7f">makeText</span>(<span style="color:#fff;font-weight:bold">this</span>, R.<span style="color:#007f7f">string</span>.<span style="color:#007f7f">map_permission_denied</span>,
</span><span style="display:block;width:100%;background-color:#191919">                Toast.<span style="color:#007f7f">LENGTH_SHORT</span>).<span style="color:#007f7f">show</span>();
</span>    }
    <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">onRequestPermissionsResult</span>(requestCode, permissions,
            grantResults);
}</code></pre></div>

<h3 id="the-test-code">The Test Code</h3>

<p>Let&rsquo;s take a stab at testing this. Here&rsquo;s what that would look like:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Test
<span style="color:#fff;font-weight:bold">public</span> void showsToastIfPermissionIsRejected()
        <span style="color:#fff;font-weight:bold">throws</span> Exception {
    MapActivity mapActivity = <span style="color:#fff;font-weight:bold">new</span> MapActivity();

    mapActivity.<span style="color:#007f7f">onRequestPermissionsResult</span>(
            MapActivity.<span style="color:#007f7f">REQUEST_LOCATION_PERMISSION</span>,
            <span style="color:#fff;font-weight:bold">new</span> String[]{MapActivity.<span style="color:#007f7f">LOCATION_PERMISSION</span>}, <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">int</span>[]{
                    PackageManager.<span style="color:#007f7f">PERMISSION_DENIED</span>});

    assertToastDisplayed();
}</code></pre></div>

<p>Hopefully, you&rsquo;re wondering what the implementation of <code>assertToastDisplayed()</code> looks like. Here&rsquo;s the thing: there isn&rsquo;t a straight forward implementation of that method. In order to implement without refactoring our code, we&rsquo;d need to use a combination of roboelectric and powermock.</p>

<p>However, since we are trying to listen to our tests and <a href="/post/why-i-dont-use-roboletric/">change the way we write code, rather than change the way we write tests</a>, we are going to stop for a moment and think about what this test is trying to tell us:</p>

<blockquote>
<p>Our presentation logic that lives inside of <code>MapActivity</code> is tightly coupled with <code>Toast</code>.</p>
</blockquote>

<p>This coupling is what drives us to use roboelectric to give us mocked android behavior and  powermock to mock the static <code>Toast.makeText</code> method. Instead, let&rsquo;s listen to our test and remove the coupling.</p>

<p>To guide our refactoring, let&rsquo;s write our test first. This will ensure that our <em>new</em> classes are loosely coupled. We have to create a new class in this particular case in order to avoid Roboelectric, but ordinarily, we could just refactor already existing classes to reduce coupling.</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Test
<span style="color:#fff;font-weight:bold">public</span> void displaysErrorWhenPermissionRejected() <span style="color:#fff;font-weight:bold">throws</span> Exception {

    OnPermissionResultListener onPermissionResultListener =
            <span style="color:#fff;font-weight:bold">new</span> OnPermissionResultListener(mPermittedView);

    onPermissionResultListener.<span style="color:#007f7f">onPermissionResult</span>(
            MapActivity.<span style="color:#007f7f">REQUEST_LOCATION_PERMISSION</span>,
            <span style="color:#fff;font-weight:bold">new</span> String[]{MapActivity.<span style="color:#007f7f">LOCATION_PERMISSION</span>},
            <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">int</span>[]{PackageManager.<span style="color:#007f7f">PERMISSION_DENIED</span>});

    verify(mPermittedView).<span style="color:#007f7f">displayPermissionDenied</span>();
}</code></pre></div>

<p>We&rsquo;ve introduced a <code>OnPermissionResultListener</code> whose job is just to handle the result of request permission from a user. Here&rsquo;s the code for that:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">void</span> onPermissionResult(<span style="color:#fff;font-weight:bold">final</span> int requestCode,
            <span style="color:#fff;font-weight:bold">final</span> String[] permissions, <span style="color:#fff;font-weight:bold">final</span> int[] grantResults) {
    <span style="color:#fff;font-weight:bold">if</span> (requestCode != MapActivity.<span style="color:#007f7f">REQUEST_LOCATION_PERMISSION</span>) {
        <span style="color:#fff;font-weight:bold">return</span>;
    }

    <span style="color:#fff;font-weight:bold">if</span> (permissions.<span style="color:#007f7f">length</span> == 1 &amp;&amp;
            MapActivity.<span style="color:#007f7f">LOCATION_PERMISSION</span>.<span style="color:#007f7f">equals</span>(permissions[0]) &amp;&amp;
            grantResults[0] == PackageManager.<span style="color:#007f7f">PERMISSION_GRANTED</span>) {
        <span style="color:#007f7f">// Permission has been granted.
</span><span style="display:block;width:100%;background-color:#191919"><span style="color:#007f7f"></span>        mPermittedView.<span style="color:#007f7f">displayPermittedView</span>();
</span>
    } <span style="color:#fff;font-weight:bold">else</span> {
        <span style="color:#007f7f">// Permission was denied. Display error message.
</span><span style="display:block;width:100%;background-color:#191919"><span style="color:#007f7f"></span>        mPermittedView.<span style="color:#007f7f">displayPermissionDenied</span>();
</span>    }
}</code></pre></div>

<p>The calls to <code>MapFragment</code> and <code>Toast</code> have been replaced with method calls on the <code>PermittedView</code>, an object that gets passed in through the constructor. <code>PermittedView</code> is an interface:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">interface</span> PermittedView {
    <span style="color:#fff;font-weight:bold">void</span> displayPermissionDenied();

    <span style="color:#fff;font-weight:bold">void</span> displayPermittedView();
}</code></pre></div>

<p>And it gets implemented by the <code>MapActivity</code>:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">public</span> class MapActivity extends BaseActivity
<span style="display:block;width:100%;background-color:#191919">        implements SlideableInfoFragment.<span style="color:#007f7f">Callback</span>, MapFragment.<span style="color:#007f7f">Callbacks</span>,
</span>        ActivityCompat.<span style="color:#007f7f">OnRequestPermissionsResultCallback</span>,
<span style="display:block;width:100%;background-color:#191919">        OnPermissionResultListener.<span style="color:#007f7f">PermittedView</span> {
</span>    @Override
    <span style="color:#fff;font-weight:bold">public</span> void displayPermissionDenied() {
        Toast.<span style="color:#007f7f">makeText</span>(MapActivity.<span style="color:#007f7f">this</span>, R.<span style="color:#007f7f">string</span>.<span style="color:#007f7f">map_permission_denied</span>,
                Toast.<span style="color:#007f7f">LENGTH_SHORT</span>).<span style="color:#007f7f">show</span>();
    }
}</code></pre></div>

<p>This may not the <em>best</em> solution, but it gets us to a point where we can test things. This <em>required</em> that <code>OnPermissionResultListener</code> be loosely coupled with its <code>PermittedView</code>. Loose coupling == definitely an improvement.</p>

<h3 id="who-cares">Who cares?</h3>

<p>At this point, some readers might be skeptical. &ldquo;Is this definitely an improvement?,&rdquo; they may wonder to themselves. Here are two reasons why this <em>design</em> is better.</p>

<p>(Neither reason I give, you&rsquo;ll notice is &ldquo;the design is better because its testable.&rdquo; That would be circular reasoning.)</p>

<h4 id="easier-changes">Easier Changes</h4>

<p>First, its going to be easier to change this code now that it consists of loosely coupled components, and here&rsquo;s the kicker: the code that we&rsquo;ve just tested from the Google I/O app <em>actually did change</em>, and with the tests that we have in place, making those changes will be easier. The code I tested was from <a href="https://github.com/google/iosched/blob/bd31a838ce4ddc123c71025c859959517c7ae178/android/src/main/java/com/google/samples/apps/iosched/map/MapActivity.java">an older commit</a>. Later on, the folks working on the I/O app decided to replace the <code>Toast</code> with a <code>Snackbar</code>:</p>

<p><img src="/images/permission-denied-snackbar.png" alt="snackbar permission rejected" /></p>

<p>Its a small change, but because we&rsquo;ve separated <code>OnPermissionResultListener</code> from <code>PermittedView</code>, we can make the change on the <code>MapActivity</code>s implementation of <code>PermittedView</code> without having to think at all about the <code>OnPermissionResultListener</code>.</p>

<p>Here&rsquo;s what that change would have looked like, using their little <code>PermissionUtils</code> class they wrote for displaying <code>SnackBar</code>s.</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Override
<span style="color:#fff;font-weight:bold">public</span> void displayPermissionDenied() {
    PermissionsUtils.<span style="color:#007f7f">displayConditionalPermissionDenialSnackbar</span>(<span style="color:#fff;font-weight:bold">this</span>,
            R.<span style="color:#007f7f">string</span>.<span style="color:#007f7f">map_permission_denied</span>, <span style="color:#fff;font-weight:bold">new</span> String[]{LOCATION_PERMISSION},
            REQUEST_LOCATION_PERMISSION);
}</code></pre></div>

<p>Again, notice that we can make this change without thinking about the <code>OnPermissionResultListener</code> at all. This is actually exactly what Larry Constantine was talking about when he first defined the concept of coupling back in the 70s:</p>

<blockquote>
<p>what we are striving for is loosely coupled systems…in which one can study (or debug, or maintain) any one module without having to know very much about any other modules in the system</p>

<p>–Edward Yourdon and Larry Constantine, Structured Design</p>
</blockquote>

<h4 id="reducing-duplication">Reducing Duplication</h4>

<p>Here&rsquo;s another interesting reason to why the fact that our tests have forced us to remove coupling is a good thing: coupling often leads to duplication. Here&rsquo;s Kent Beck on this:</p>

<blockquote>
<p>Dependency is the key problem in software development at all scales…if dependency is the problem, duplication is the symptom.</p>

<p>-Kent Beck, TDD By Example, pg 7.</p>
</blockquote>

<p>If this is true, when we remove coupling, we will often see opportunities to reduce duplication. Indeed, this is precisely what we find in this case. It turns out that there is  another classes whose <code>onRequestPermissionsResult</code> is nearly identical to the one in <code>MapActivity</code>: <a href="https://github.com/google/iosched/blob/bd31a838ce4ddc123c71025c859959517c7ae178/android/src/main/java/com/google/samples/apps/iosched/welcome/AccountFragment.java#L139"><code>AccountFragment</code></a>. Our tests drove us to create two classes <code>OnPermissionResultListener</code> and <code>PermittedView</code> that &ndash; without much modification &ndash; can be reused in these other classes.</p>

<h3 id="conclusion">Conclusion</h3>

<p>So, when we have a hard time testing our <code>Activity</code>s and <code>Fragment</code>s, its often because our tests are trying to tell us that our code is tightly coupled. The test&rsquo;s warning about coupling often come in the form of an inability to make an assertion against the code we&rsquo;re trying to test.<sup>1</sup></p>

<p>When we listen to our tests, instead of changing them by using Roboelectric our powermock, we&rsquo;re lead to change in our code in a way that makes it less coupled, which makes it easier to make changes and opens up opportunities to reduce duplication.</p>

<h3 id="notes">Notes</h3>

<ol>
<li>It could also show up as an inability to get your target code into the right state for testing. That&rsquo;s what we saw <a href="">in this post</a>, for example.</li>
</ol>

                </article>
          </div>
        </section>                
  </div>
  
</div>
<footer class="page-footer green text-white">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
            
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<div id="mc_embed_signup">
<form action="//appspot.us11.list-manage.com/subscribe/post?u=9612e1a3261cb5689813bf38b&amp;id=0c5f737d6c" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<label for="mce-EMAIL">Get Email Updates</label>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9612e1a3261cb5689813bf38b_0c5f737d6c" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>


            <div class="rc-scout" style="text-align: center;"></div>    
        </div>
        <aside id="meta">            
            <div>
                
                <div>                  
                  <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/post/why-cryptography-for-android-developers/">Previous: Why Cryptography?</a>
                </div>
                
                
                <div>                  
                  <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/post/android-testing-calisthenics-domain-objects/">Next: Android Testing Calisthenics: Domain Objects</a>
                </div>
                
            </div>
        </aside>  
        <div class="col l4 offset-l2 s12">
          <h5 class="white-text">Tags</h5>
          <ul>              
              
              <ul id="tags">
                
                  <li> <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/tags/android">android</a> </li>
                
                  <li> <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/tags/testing">testing</a> </li>
                
                  <li> <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/tags/architecture">architecture</a> </li>
                
              </ul>
                          
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-copyright">
      <div class="container">
      © 2019 Matt Dupree
      </div>
    </div>    
  </footer>        


        </div><script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var elems = document.querySelectorAll(".sidenav");
    var instances = M.Sidenav.init(elems, {});
  });
</script>
<script async defer src="https://www.recurse-scout.com/loader.js?t=b7a91d718a76fe21289fbe7d51a58f19"></script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-63544399-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>
</html>
