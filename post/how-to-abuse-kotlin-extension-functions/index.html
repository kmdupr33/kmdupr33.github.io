<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8" />
  <meta
    name="description"
    content=""
  />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
  />
  <link href="/css/all.min.css" rel="stylesheet" />
  <style>
    #content {
      font-size: 18px;
      line-height: 1.7;
    }
    #content img {
      max-width: 100%;
    }
    #mc_embed_signup label {
      color: white;
    }
    #mc_embed_signup input.email {
      color: white;
      border-color: white;
    }

    #mc_embed_signup input.button {
      background-color: #ee6e73;
    }
    .rc-scout .rc-scout__link:link {
      color: white;
    }
    .browser-default-uls ul {
      padding-left: 30px;
      margin-top: 10px;
      margin-bottom: 15px;
    }
    .browser-default-uls ul > li {
      list-style-type: disc !important;
    }
    pre {
      overflow: auto;
      padding: 15px;
    }
  </style>
  <title>Philosophical Hacker</title>
</head>
<body><nav>
  <div class="nav-wrapper green">
    <a
      href="/"
      class="brand-logo"
      style="margin-left: 10px;"
      >Philosophical Hacker</a
    >
    <a href="#" data-target="mobile-demo" class="sidenav-trigger"
      ><i class="material-icons">menu</i></a
    >
    <ul class="right hide-on-med-and-down">      
      <li><a href="/about/me">About</a></li>
      
      <li><a href="/note">Notes</a></li>
      <li>
        <a
          href="https://www.oreilly.com/library/view/~/9781492048343/?intcmp=il-prog-free-product-na_new_site_rxjava_for_android_app_development"
          >RxJava O'Reilly Ebook</a
        >
      </li>
      <li>
          <a href="https://twitter.com/philosohacker"
            ><i class="fab fa-twitter"></i
          ></a>
        </li>
        <li>
          <a href="https://www.linkedin.com/in/k-matthew-dupree-44672178/"
            ><i class="fab fa-linkedin-in"></i
          ></a>
        </li>
    </ul>
  </div>
  <ul class="sidenav" id="mobile-demo">    
    <li><a href="/about/me">About</a></li>
    
    <li><a href="/note">Notes</a></li>
    <li>
      <a
        href="https://www.oreilly.com/library/view/~/9781492048343/?intcmp=il-prog-free-product-na_new_site_rxjava_for_android_app_development"
        >Rx Java O'Reilly Ebook</a
      >
    </li>
    <li>
        <a href="https://twitter.com/philosohacker"
          ><i class="fab fa-twitter"></i
        ></a>
      </li>
      <li>
        <a href="https://www.linkedin.com/in/k-matthew-dupree-44672178/"
          ><i class="fab fa-linkedin-in"></i
        ></a>
      </li>
  </ul>
</nav>
<div id="content" class="browser-default-uls">

    <img style="filter: brightness(.4); width: 100%;" src="/images/sweets.jpg"/>

<div class="row">
  <div class="col s12 m6 offset-m3">
      <section id="main">          
          <h1 id="title">How to Abuse Kotlin Extension Functions</h1>
          
          <p id="date"> Fri May 26, 2017 | 6 Minute read </p>
          <div>
                <article id="content">
                   

<p>I&rsquo;ve got a &ldquo;sweet tooth,&rdquo; which, in my case, is just a euphemism for me saying that I&rsquo;m <em>addicted</em> to sugar. I&rsquo;m young now, but I know that this addiction won&rsquo;t end well once my metabolism slows down, so I try go to the gym.</p>

<p>Unfortunately, when I leave the gym, I often think to myself, &ldquo;I just worked out, so I can snag that Oreo McFlurry I&rsquo;ve been craving all day.&rdquo; When I do this, I abuse exercise: I take a good thing &mdash; exercise &mdash; and I use it to justify engaging in a bad habit &mdash; consuming empty calories. Hold that thought.</p>

<p>I started using Kotlin this week. Overall, Kotlin is absolutely delightful, but heaping unqualified additional praise on an already hyped language doesn&rsquo;t make good toilet reading, so let&rsquo;s mix things up a bit.</p>

<p>I want to talk about a Kotlin language feature that I&rsquo;m not thrilled about. I&rsquo;m less than ecstatic about this feature because I think that its likely to be abused. Just as I can take something good like exercise and use it to justify a bad habit, we can take good Kotlin language features and use them to continue and exacerbate our bad Java coding habits into our Kotlin code.</p>

<p>More specifically, I&rsquo;m worried about extension functions. I&rsquo;m worried that extensions will make it easier for us to avoid creating clean abstractions in our code. Let&rsquo;s look at this in detail so that we can avoid abusing extension functions.</p>

<p>First, we&rsquo;ll look at the original intent of extension functions. Then, we&rsquo;ll examine an example in <a href="https://github.com/google/iosched">the Google I/O codebase</a> where I think extension functions are getting abused, and we&rsquo;ll talk specifically about why I think we have a bona-fide example of abuse on our hands. Finally, I&rsquo;ll talk about a better way of structuring the abusive code.</p>

<h3 id="why-extensions-are-good-thing-sometimes">Why Extensions are Good Thing (sometimes)</h3>

<p>Before we look at how extensions can be abused, let&rsquo;s look at what they&rsquo;re good for. <a href="https://kotlinlang.org/docs/reference/extensions.html#motivation">The &ldquo;motivation&rdquo; section of the docs on this feature</a> is helpful here:</p>

<blockquote>
<p>In Java, we are used to classes named &ldquo;*Utils&rdquo;: FileUtils, StringUtils and so on. The famous java.util.Collections belongs to the same breed. And the unpleasant part about these Utils-classes is that&hellip;class names are always getting in the way.</p>
</blockquote>

<p>The example they have for this is brilliant:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Collections.<span style="color:#007f7f">swap</span>(list, 
                Collections.<span style="color:#007f7f">binarySearch</span>(list, Collections.<span style="color:#007f7f">max</span>(otherList)), 
                Collections.<span style="color:#007f7f">max</span>(list))</code></pre></div>

<p>Because of the code completion and improved readability, the kotlin folks rightly point out that we&rsquo;d rather write:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">list.<span style="color:#007f7f">swap</span>(list.<span style="color:#007f7f">binarySearch</span>(otherList.<span style="color:#007f7f">max</span>()), list.<span style="color:#007f7f">max</span>())</code></pre></div>

<p>However, we can&rsquo;t implement all possible list methods inside of the list class, so, in order to achieve this, we need to a way to write list methods outside of the list class. And that, boys and girls, is where extension functions come from.</p>

<h3 id="an-example-extension-function-abuse">An Example Extension Function Abuse</h3>

<p>In some cases, this seems like a great addition to the language. Where could we go wrong here? To answer this question, let&rsquo;s look at some Google I/O code that could be refactored to use extension functions, but probably shouldn&rsquo;t be.</p>

<p>The Google I/O code base contains a <code>SettingsUtils</code> class. Its 484 lines long and has 33 methods. Yuck. Call sites of the methods on this class, moreover, don&rsquo;t look great:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007f7f">// Ensure we don&#39;t run this fragment again
</span><span style="color:#007f7f"></span>LOGD(TAG, <span style="color:#0ff;font-weight:bold">&#34;Marking attending flag.&#34;</span>);
SettingsUtils.<span style="color:#007f7f">setAttendeeAtVenue</span>(mActivity, <span style="color:#fff;font-weight:bold">true</span>);
SettingsUtils.<span style="color:#007f7f">markAnsweredLocalOrRemote</span>(mActivity, <span style="color:#fff;font-weight:bold">true</span>);</code></pre></div>

<p>Now, using an extension method on a <code>Context</code> might make some of this code look a little better:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#007f7f">// PrefExtensions.kt
</span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">fun</span> Context.setAttendeeAtVenue(newValue: Boolean) {
    <span style="color:#fff;font-weight:bold">val</span> defaultSharedPreferences = PreferenceManager.getDefaultSharedPreferences(<span style="color:#fff;font-weight:bold">this</span>)
    defaultSharedPreferences.edit().putBoolean(BuildConfig.PREF_ATTENDEE_AT_VENUE, newValue).apply()
}

<span style="color:#fff;font-weight:bold">fun</span> Context.markAnsweredLocalOrRemote(newValue: Boolean) {
    <span style="color:#fff;font-weight:bold">val</span> sp = PreferenceManager.getDefaultSharedPreferences(<span style="color:#fff;font-weight:bold">this</span>)
    sp.edit().putBoolean(PREF_ANSWERED_LOCAL_OR_REMOTE, newValue).apply()
}

<span style="color:#007f7f">// AttendingFragment.kt
</span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">override</span> <span style="color:#fff;font-weight:bold">fun</span> onClick(v: View) {
    <span style="color:#007f7f">// Ensure we don&#39;t run this fragment again
</span><span style="color:#007f7f"></span>    LOGD(TAG, <span style="color:#0ff;font-weight:bold">&#34;Marking attending flag.&#34;</span>)
    mActivity.setAttendeeAtVenue(<span style="color:#fff;font-weight:bold">true</span>)
    mActivity.markAnsweredLocalOrRemote(<span style="color:#fff;font-weight:bold">true</span>)
}</code></pre></div>

<p>Even if you&rsquo;re not crazy enough to add extension functions to <a href="/post/towards-godless-android-development-how-and-why-i-kill-god-objects/">a god object</a>, you might be tempted to kotlinify this code by writing an extension function for <code>SharedPreferences</code>. I still that that would be a mistake.</p>

<h3 id="why-abuse">Why Abuse?</h3>

<p>Extension functions, as their name implies, are good for <em>extending</em> existing abstractions. They&rsquo;re abused when we use them to palliate the use of a bad or entirely absent abstractions.</p>

<p>To see why this particular example is an abuse of extension functions, let&rsquo;s back up a second and think back to the <code>SettingsUtil</code> class. <code>Util*</code> classes, in many cases, are substitutes for missing or poorly formed abstractions. That&rsquo;s true in this case.</p>

<p>Is the attendee&rsquo;s physical location in relation to the Google I/O conference a Setting? Not really.</p>

<p>Its implemented as a <code>SharedPreference</code>, so it gets lumped in with all the other SharedPreference-related methods in <code>SettingsUtils</code>, but these two methods are really part of something that&rsquo;s different from a <code>SharedPreference</code>. <code>SharedPreference</code> is just an implementation detail. <code>SharedPreferences</code> can be a bit annoying to get a hold of, so to make matters worse, this bag of methods lives in an utility class.</p>

<p>This has two consequences: First, <code>SettingsUtil</code> and <code>AttendingFragment</code> are harder to understand because they have low cohesion. Second, <code>SettingsUtil</code> and <code>AttendingFragment</code> are overly coupled, which will make testing and maintenance more difficult.</p>

<p>Let&rsquo;s look at cohesion-related consequences first. <code>SettingsUtil</code> is a class that&rsquo;s hard to grok because its just an random bag of 34 conceptually unrelated methods that all happen to rely on <code>SharedPreferences</code> as an implementation detail. Because the purpose of <code>SettingsUtil</code> is hard to understand, the purpose of <code>AttendingFragment</code>, a class that relies on it is also obscured, albeit to a lesser degree.</p>

<p>Here&rsquo;s the kicker: moving to extension functions doesn&rsquo;t do anything to solve this problem.</p>

<p>Next, the coupling-related consequences. <em>Extensions are resolved statically.</em> This means that code that depends on extension methods are <em>tightly coupled</em> to a single implementation of an extension method.</p>

<p>Java&rsquo;s static methods result in the same exact degree of coupling, and that&rsquo;s the point here: moving to extension functions doesn&rsquo;t really solve the deeper problem here. You&rsquo;re code looks a little nicer, but its still tightly coupled.</p>

<p>So, on both counts, using extension functions in this case merely helps us put lipstick on a pig. As I said at the outset of this section, extension functions are better used when we want to extend an already existing abstraction.</p>

<h3 id="a-better-way">A better way</h3>

<p>To solidify the idea that using a function extension in this case would be an abuse, let&rsquo;s look at a better way of handling the above code. As far as I can tell, the missing abstraction here is an <code>Attendee</code>:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#fff;font-weight:bold">interface</span> Attendee {
    <span style="color:#fff;font-weight:bold">enum</span> <span style="color:#fff;font-weight:bold">class</span> Attending {
        IN_PERSON,
        REMOTE,
        UNKNOWN
    }

    <span style="color:#fff;font-weight:bold">fun</span> setAtVenue(newValue: Boolean)
    <span style="color:#fff;font-weight:bold">fun</span> attending(): Attending
}</code></pre></div>

<p>It turns out that there are other <code>SettingsUtil</code> methods that make sense to move to this interface. Conference attendees accept a code of conduct that is presented in the <code>ConductFragment</code>.</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#fff;font-weight:bold">interface</span> Attendee {
    <span style="color:#007f7f">//...
</span><span style="color:#007f7f"></span>
    <span style="color:#fff;font-weight:bold">fun</span> acceptCodeOfConduct(newValue: Boolean)
    <span style="color:#fff;font-weight:bold">fun</span> hasAcceptedCodeOfConduct(): Boolean
}</code></pre></div>

<p>Now that we&rsquo;ve filled out the methods on this interface, we can see that the call sites of <code>Attendee</code> methods are simpler and more easily understood than their <code>SettingsUtils</code> counter-parts:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#007f7f">// AttendingFragment.kt
</span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">override</span> <span style="color:#fff;font-weight:bold">fun</span> onClick(v: View) {
    <span style="color:#007f7f">// Ensure we don&#39;t run this fragment again
</span><span style="color:#007f7f"></span>    LOGD(TAG, <span style="color:#0ff;font-weight:bold">&#34;Marking attending flag.&#34;</span>)
    attendee.setAtVenue(<span style="color:#fff;font-weight:bold">true</span>)    
    <span style="color:#007f7f">// Notice we dont need to call SettingsUtils.markAnsweredLocalOrRemote.
</span><span style="color:#007f7f"></span>}</code></pre></div>

<h3 id="conclusion">Conclusion</h3>

<p>With these changes, the <code>SettingsUtils</code> class loses 5 methods, thereby getting a little more digestible. The <code>SharedPrefsAttendee</code> implementation, as you can imagine, is short (24 kotlin lines) and easily grokked. Classes that use the <code>Attendee</code> abstraction are a little clearer and a little simpler. They also aren&rsquo;t tightly coupled with a specific implementation, which makes them easier to test and maintain.</p>

<p>So, don&rsquo;t abuse Kotlin&rsquo;s extension functions. They&rsquo;re neat, but sometimes plain old OO techniques are a better choice. Identifying a missing or bad abstraction is often a better way to approach <code>*Util</code> classes.</p>

                </article>
          </div>
        </section>                
  </div>
  
</div>
<footer class="page-footer green text-white">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
            
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<div id="mc_embed_signup">
<form action="//appspot.us11.list-manage.com/subscribe/post?u=9612e1a3261cb5689813bf38b&amp;id=0c5f737d6c" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<label for="mce-EMAIL">Get Email Updates</label>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9612e1a3261cb5689813bf38b_0c5f737d6c" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>


            <div class="rc-scout" style="text-align: center;"></div>    
        </div>
        <aside id="meta">            
            <div>
                
                <div>                  
                  <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/post/not-needing-dagger-is-a-smell-pt-1/">Previous: Not Needing Dagger is a Code Smell (Pt. 1)</a>
                </div>
                
                
                <div>                  
                  <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/post/react-native-at-an-iot-startup/">Next: React Native at an IoT Startup</a>
                </div>
                
            </div>
        </aside>  
        <div class="col l4 offset-l2 s12">
          <h5 class="white-text">Tags</h5>
          <ul>              
              
              <ul id="tags">
                
                  <li> <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/tags/android">android</a> </li>
                
                  <li> <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/tags/kotlin">kotlin</a> </li>
                
                  <li> <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/tags/architecture">architecture</a> </li>
                
              </ul>
                          
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-copyright">
      <div class="container">
      Â© 2019 Matt Dupree
      </div>
    </div>    
  </footer>        


        </div><script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var elems = document.querySelectorAll(".sidenav");
    var instances = M.Sidenav.init(elems, {});
  });
</script>
<script async defer src="https://www.recurse-scout.com/loader.js?t=b7a91d718a76fe21289fbe7d51a58f19"></script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-63544399-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>
</html>
