<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8" />
  <meta
    name="description"
    content=""
  />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
  />
  <link href="/css/all.min.css" rel="stylesheet" />
  <style>
    #content {
      font-size: 18px;
      line-height: 1.7;
    }
    #content img {
      max-width: 100%;
    }
    #mc_embed_signup label {
      color: white;
    }
    #mc_embed_signup input.email {
      color: white;
      border-color: white;
    }

    #mc_embed_signup input.button {
      background-color: #ee6e73;
    }
    .rc-scout .rc-scout__link:link {
      color: white;
    }
    .browser-default-uls ul {
      padding-left: 30px;
      margin-top: 10px;
      margin-bottom: 15px;
    }
    .browser-default-uls ul > li {
      list-style-type: disc !important;
    }
    pre {
      overflow: auto;
      padding: 15px;
    }
  </style>
  <title> What makes Android Apps Testable? | Philosophical Hacker </title>
  
  
</head>
<body><nav>
  <div class="nav-wrapper green">
    <a
      href="/"
      class="brand-logo"
      style="margin-left: 10px;"
      >Philosophical Hacker</a
    >
    <a href="#" data-target="mobile-demo" class="sidenav-trigger"
      ><i class="material-icons">menu</i></a
    >
    <ul class="right hide-on-med-and-down">      
      <li><a href="/about/me">About</a></li>
      <li><a href="/talk">Talks</a></li>
      <li><a href="/note">Notes</a></li>
      <li>
        <a
          href="https://www.oreilly.com/library/view/~/9781492048343/?intcmp=il-prog-free-product-na_new_site_rxjava_for_android_app_development"
          >RxJava O'Reilly Ebook</a
        >
      </li>
      <li>
          <a href="https://twitter.com/philosohacker"
            ><i class="fab fa-twitter"></i
          ></a>
        </li>
        <li>
          <a href="https://www.linkedin.com/in/k-matthew-dupree-44672178/"
            ><i class="fab fa-linkedin-in"></i
          ></a>
        </li>
    </ul>
  </div>
  <ul class="sidenav" id="mobile-demo">    
    <li><a href="/about/me">About</a></li>
    <li><a href="/talk">Talks</a></li>
    <li><a href="/note">Notes</a></li>
    <li>
      <a
        href="https://www.oreilly.com/library/view/~/9781492048343/?intcmp=il-prog-free-product-na_new_site_rxjava_for_android_app_development"
        >Rx Java O'Reilly Ebook</a
      >
    </li>
    <li>
        <a href="https://twitter.com/philosohacker"
          ><i class="fab fa-twitter"></i
        ></a>
      </li>
      <li>
        <a href="https://www.linkedin.com/in/k-matthew-dupree-44672178/"
          ><i class="fab fa-linkedin-in"></i
        ></a>
      </li>
  </ul>
</nav>
<div id="content" class="browser-default-uls">

    <img style="filter: brightness(.4); width: 100%;" src="/images/ascending-and-descending-escher.jpg"/>

<div class="row">
  <div class="col s12 m6 offset-m3">
      <section id="main">          
          <h1 id="title">What makes Android Apps Testable?</h1>
          
          <p id="date" class="grey-text text-darken-1i"> Sat Dec 3, 2016 | 7 Minute read </p>
          <div>
                <article id="content">
                   <p>This post is a continuation of my attempt to reproduce <a href="https://devfestflorida.org/schedule/day1?sessionId=113">my recent DevFest talk</a> in written form.</p>

<h3 id="penrose-steps-dr-jekyll-mr-hyde-and-android-testing">Penrose Steps, Dr. Jekyll/Mr. Hyde, and Android Testing</h3>

<p>Let&rsquo;s say you&rsquo;re sold on the importance of testing. (If not, maybe check out <a href="/post/why-we-should-probably-write-more-tests-for-our-android-apps/">this article</a>.) Let&rsquo;s say you actually start using the junit dependency that&rsquo;s been sitting in your build.gradle file and try to write your first test. I suspect that you&rsquo;re going to find yourself in a kind of &ldquo;penrose steps situation.&rdquo;</p>

<p>The penrose steps, shown above, is an impossible structure. Penrose steps cannot exist in 3d space. What&rsquo;s interesting about the 2d image of penrose steps, however, is that its not immediately obvious that what is being depicted is impossible.</p>

<p>Something similar can happen when we go to start writing tests for our code. We look at our code and we think, &ldquo;I can totally write tests for this.&rdquo; Upon further inspection, however, we realize. &ldquo;Oh wait. This is actually impossible.&rdquo; This penrose steps experience isn&rsquo;t limited to Android developers:</p>

<blockquote>
<p>Something nearly everyone notices when they try to write tests for existing code is just how poorly suited code is to testing.</p>

<p>&ndash; Michael Feathers, Working Effectively with Legacy Code</p>
</blockquote>

<p>Testing support for Android has gotten a lot better in the past couple of years, but I think that actually attempting to use the testing tools that are now available for Android has helped us realize that our apps aren&rsquo;t actually structured in a way that makes testing easy and in some cases, our architectures simply make it impossible to test our code.</p>

<p>This mismatch between our good intentions and our poorly structured apps can lead us to a kind of Dr. Jekyll and Mr. Hyde situation.</p>

<p><img src="/images/dr-jekyll-poster.jpg" alt="Dr Jekyll Poster" /></p>

<p>Dr. Jekyll was a good dude, but he was messing with something he didn&rsquo;t understand and that led him to transform into Mr. Hyde, the guy that does unspeakable things. Similarly, developers who want to test their code have good intentions, but if they don&rsquo;t understand what makes code testable, they can do unspeakably (terrible) things to a codebase.</p>

<p>Case in point: <a href="https://github.com/google/iosched/blob/2015/android/src/main/java/com/google/samples/apps/iosched/framework/PresenterFragmentImpl.java#L185">The google 2015 I/O app</a> contains a particularly egregious violation of the principle of single responsibility:<sup>1</sup></p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">public</span> class PresenterFragmentImpl extends Fragment
        implements Presenter, UpdatableView.<span style="color:#007f7f">UserActionListener</span>,
        LoaderManager.<span style="color:#007f7f">LoaderCallbacks</span>&lt;Cursor&gt; {

    @Override
    <span style="color:#fff;font-weight:bold">public</span> Loader&lt;Cursor&gt; onCreateLoader(<span style="color:#fff;font-weight:bold">int</span> id, Bundle args) {
        Loader&lt;Cursor&gt; cursorLoader = createLoader(id, args);
<span style="display:block;width:100%;background-color:#191919">        mLoaderIdlingResource.<span style="color:#007f7f">onLoaderStarted</span>(cursorLoader);
</span>        <span style="color:#fff;font-weight:bold">return</span> cursorLoader;
    }

    @Override
    <span style="color:#fff;font-weight:bold">public</span> void onLoadFinished(Loader&lt;Cursor&gt; loader,
                               Cursor data) {
        processData(loader, data);
<span style="display:block;width:100%;background-color:#191919">        mLoaderIdlingResource.<span style="color:#007f7f">onLoaderFinished</span>(loader);
</span>    }
}</code></pre></div>

<p>This code snippet mixes production code and test code. That&rsquo;s pretty unfortunate.</p>

<h3 id="what-makes-software-testable">What Makes Software Testable?</h3>

<p>To avoid Penrose steps and Dr. Jekyll scenarios while we&rsquo;re trying to write tests for our Android apps, its helpful to have an answer to the question, &ldquo;What makes Software Testable?&rdquo; This picture suggests a metaphor for thinking about the answer to that question, a metaphor that I stole from Michal Feathers:</p>

<p><img src="/images/seam.png" alt="a seam in jeans pant leg" /></p>

<p>If we want to change the appearance of this piece of fabric, we have two options: we could just directly apply whatever changes we want to the pieces of fabric that are joined at the seam. Another option, however, is to undo the seam and replace one piece of fabric with another.</p>

<p>Similarly, when we want to change the behavior of code for testing purposes, we have two options: we can directly apply our changes to the particular source file or we can use what Feather&rsquo;s calls a &ldquo;seam&rdquo; to change the code&rsquo;s behavior. Here&rsquo;s how Feathers defines a seam:</p>

<blockquote>
<p>A seam is a place where you can alter behavior in your program without editing in that place.</p>
</blockquote>

<p>Perhaps the easiest way of fleshing out this concept of a seam to see what it feels like to try to write tests for code that has no seams. Say we wanted to write code for a piece of functionality in the Google I/O app:</p>

<p><img src="/images/settings.png" alt="settings screen" /></p>

<p>This toggle determines whether the google I/O calendar should be synced to the user&rsquo;s personal calendar. Here&rsquo;s the code for it:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Override
<span style="color:#fff;font-weight:bold">public</span> void onSharedPreferenceChanged(SharedPreferences sharedPrefs,
                            String key) {

    <span style="color:#fff;font-weight:bold">if</span> (SettingsUtils.<span style="color:#007f7f">PREF_SYNC_CALENDAR</span>.<span style="color:#007f7f">equals</span>(key)) {
        Intent intent;
        <span style="color:#fff;font-weight:bold">if</span> (SettingsUtils.<span style="color:#007f7f">shouldSyncCalendar</span>(getActivity())) {
            <span style="color:#007f7f">// Add all calendar entries
</span><span style="color:#007f7f"></span>            intent = <span style="color:#fff;font-weight:bold">new</span> Intent(ACTION_UPDATE_ALL_SESSIONS_CALENDAR);
        } <span style="color:#fff;font-weight:bold">else</span> {
            <span style="color:#007f7f">// Remove all calendar entries
</span><span style="color:#007f7f"></span>            intent = <span style="color:#fff;font-weight:bold">new</span> Intent(ACTION_CLEAR_ALL_SESSIONS_CALENDAR);
        }

        intent.<span style="color:#007f7f">setClass</span>(getActivity(), SessionCalendarService.<span style="color:#007f7f">class</span>);
        getActivity().<span style="color:#007f7f">startService</span>(intent);
    }
}</code></pre></div>

<p>Let&rsquo;s start writing our test for it:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Test
<span style="color:#fff;font-weight:bold">public</span> void onSharedPreferenceChangedRemovesSessions() <span style="color:#fff;font-weight:bold">throws</span> Exception {
    <span style="color:#007f7f">// Arrange
</span><span style="color:#007f7f"></span>
    <span style="color:#007f7f">//Act
</span><span style="color:#007f7f"></span>    mSettingsFragment.<span style="color:#007f7f">onSharedPreferencesChanged</span>(mMockSharedPreferences,
                                  PREF_SYNC_CALENDAR);

    <span style="color:#007f7f">//Assert
</span><span style="color:#007f7f"></span>
}</code></pre></div>

<p>As the test method name implies, we want to test that <code>onSharedPreferencesChnaged</code> removes the calendar sessions appropriately.<sup>2</sup> We need to make sure the the <code>else</code> branch of the above <code>if-else</code> statement gets executed. To do that, we need to make sure that <code>SettingsUtils.shouldSyncCalendar(getActivity())</code> returns false, but we can&rsquo;t just go to the declaration of <code>SettingsUtils.shouldSyncCalendar</code> and change the code so that it returns false. <em>We need to change behavior of our code without editing it &ldquo;in place.&rdquo;</em></p>

<p>Here&rsquo;s the thing: because <code>SettingsUtils.shouldSyncCalendar</code> is a static method, we can&rsquo;t actually do this. There is no seam for us to exploit here. <em>If you code doesn&rsquo;t have seams, you&rsquo;re going to find it difficult to arrange in your tests.</em></p>

<p>Notice, moreover, that we can&rsquo;t assert in this test either. How can we assert that an Android <code>Service</code> has been launched? There&rsquo;s no straightforward way to do this, which is why <a href="https://developer.android.com/reference/android/support/test/espresso/intent/Intents.html">the Intent class</a> exists within espresso. What we need here is to be able to change the behavior of <code>Context.startService</code> so that it records that a service has been started, but we can&rsquo;t. Obviously, we can&rsquo;t edit the <code>Context.startService</code> method and we have no control over the <code>Context</code> returned by <code>getActivity</code>. We&rsquo;ll see why that would create a seam later, but the important thing to note here is that <em>if you code doesn&rsquo;t have seams, you&rsquo;re going to find it difficult to assert in your tests.</em></p>

<p>Suppose instead that the settings toggle code looked like this:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">class</span> CalendarUpdatingOnSharedPreferenceChangedListener {

    <span style="color:#fff;font-weight:bold">void</span> onPreferenceChanged(CalendarPreferences calendarPreferences,
                             String key) {

        <span style="color:#fff;font-weight:bold">if</span> (SettingsUtils.<span style="color:#007f7f">PREF_SYNC_CALENDAR</span>.<span style="color:#007f7f">equals</span>(key)) {
<span style="display:block;width:100%;background-color:#191919">            <span style="color:#fff;font-weight:bold">if</span> (calendarPreferences.<span style="color:#007f7f">shouldSyncCalendar</span>()) {
</span>                mSessUpdaterLauncher.<span style="color:#007f7f">launchAddAllSessionsUpdater</span>();
            } <span style="color:#fff;font-weight:bold">else</span> {
<span style="display:block;width:100%;background-color:#191919">                mSessUpdaterLauncher.<span style="color:#007f7f">launchClearAllSessionsUpdate</span>();
</span>            }
        }
    }
}</code></pre></div>

<p>Notice that we&rsquo;ve replaced a static method call with an instance method call. Notice also that the details of how the <code>SessionCalendarService</code> is started is hidden behind a call to <code>mSessUpdateerLauncher.launchClearAllSessionsUpdate()</code>. These two changes let us arrange and assert in our unit test:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Test
<span style="color:#fff;font-weight:bold">public</span> void onPreferenceChangedClearedCalendar() <span style="color:#fff;font-weight:bold">throws</span> Exception {

    <span style="color:#007f7f">// Arrange
</span><span style="color:#007f7f"></span>    CUOSPCListener listener
            = <span style="color:#fff;font-weight:bold">new</span> CUOSPCListener(mSessionUpdateLauncher);

    <span style="color:#fff;font-weight:bold">final</span> CalendarPreferences calendarPreferences
            = mock(CalendarPreferences.<span style="color:#007f7f">class</span>);
<span style="display:block;width:100%;background-color:#191919">    when(calendarPreferences.<span style="color:#007f7f">shouldSyncCalendar</span>()).<span style="color:#007f7f">thenReturn</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span>
    <span style="color:#007f7f">// Act
</span><span style="color:#007f7f"></span>    listener.<span style="color:#007f7f">onPreferenceChanged</span>(calendarPreferences,
                                 SettingsUtils.<span style="color:#007f7f">PREF_SYNC_CALENDAR</span>);

    <span style="color:#007f7f">// Assert
</span><span style="display:block;width:100%;background-color:#191919"><span style="color:#007f7f"></span>    verify(mSessionUpdateLauncher).<span style="color:#007f7f">launchClearAllSessionsUpdate</span>();
</span>}</code></pre></div>

<p>The changes we made to our code gave us seams that we exploited in our unit test. Using mockito<sup>3</sup>, we changed the behavior of <code>calendarPreferences.shouldSyncCalendar()</code> so that it returns false without going to the declaration of <code>CalendarPreferences.shouldSyncCalendar</code> and editing it. We also used mockito to swap out a standard <code>SessionUpdaterLauncher</code> with an implementation that records that a particular method has been called. This, of course, is what allows us to assert in our test with <code>verify</code>.</p>

<p>The seams we&rsquo;ve just created here are called &ldquo;object seams,&rdquo; and they&rsquo;re something that I&rsquo;ll cover more explicitly in <a href="/post/object-seams-and-mvp-for-testability/">my next post</a>.</p>

<h3 id="conclusion">Conclusion</h3>

<p>If you&rsquo;re sold on testing, but you don&rsquo;t understand what makes code testable, you can wind up trying to do the impossible: test untestable code. You may also wind up doing terrible things to your code base to try to add tests. You can avoid these situations by understanding what makes code testable. Testable code has seams, and without those seams, you&rsquo;re going to find it difficult to arrange and/or assert in your tests.</p>

<h2 id="notes">Notes:</h2>

<ol>
<li><p>Thankfully, it looks like they may have fixed this in <a href="https://github.com/google/iosched">the 2016 version of the Google I/O app</a>.</p></li>

<li><p>This behavior may actually be too trivial to test in real life, but its makes for a simple example.</p></li>

<li><p>Of course, using mockito to accomplish this isn&rsquo;t absolutely necessary.</p></li>
</ol>
                </article>
          </div>
        </section>                
  </div>
  
</div>
<footer class="page-footer green text-white">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
            
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<div id="mc_embed_signup">
<form action="//appspot.us11.list-manage.com/subscribe/post?u=9612e1a3261cb5689813bf38b&amp;id=0c5f737d6c" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<label for="mce-EMAIL">Get Email Updates</label>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9612e1a3261cb5689813bf38b_0c5f737d6c" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>


            <div class="rc-scout" style="text-align: center;"></div>    
        </div>
        <aside id="meta">            
            <div>
                
                <div>                  
                  <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/post/why-we-should-probably-write-more-tests-for-our-android-apps/">Previous: Why we Should Probably Write More Tests for Our Android Apps</a>
                </div>
                
                
                <div>                  
                  <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/post/object-seams-and-mvp-for-testability/">Next: Object Seams and MVP for Testability</a>
                </div>
                
            </div>
        </aside>  
        <div class="col l4 offset-l2 s12">
          <h5 class="white-text">Tags</h5>
          <ul>              
              
              <ul id="tags">
                
                  <li> <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/tags/android">android</a> </li>
                
                  <li> <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/tags/testing">testing</a> </li>
                
              </ul>
                          
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-copyright">
      <div class="container">
      Â© 2019 Matt Dupree
      </div>
    </div>    
  </footer>        


        </div><script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var elems = document.querySelectorAll(".sidenav");
    var instances = M.Sidenav.init(elems, {});
  });
</script>
<script async defer src="https://www.recurse-scout.com/loader.js?t=b7a91d718a76fe21289fbe7d51a58f19"></script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-63544399-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>
</html>
