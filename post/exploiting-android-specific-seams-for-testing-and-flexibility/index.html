<!DOCTYPE html>
<html lang="en-us">
<head>

    <style type="text/css">
      #mc_embed_signup {
        margin-top: 50px;
        margin-bottom: 50px;        
        display: flex;
        justify-content: center;
        font:14px "Open Sans",Arial,sans-serif;
      }
      #mc_embed_signup input.button {
        background: black;
      }
    </style>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    


    
        <meta name="twitter:card" content="summary"/>
    



<meta name="twitter:title" content="Exploiting Android-Specific Seams for Testing and Flexibility"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@philosohacker"/>



  	<meta property="og:title" content="Exploiting Android-Specific Seams for Testing and Flexibility &middot; Philosophical Hacker" />
  	<meta property="og:site_name" content="Philosophical Hacker" />
  	<meta property="og:url" content="https://www.philosophicalhacker.com/post/exploiting-android-specific-seams-for-testing-and-flexibility/" />
    
    
        
            <meta property="og:image" content="https://www.philosophicalhacker.com/images/cropped-thinker.jpg"/>
        
    

    
    <meta property="og:description" content="" />
  	<meta property="og:type" content="article" />
    <meta property="og:image" content="https://www.philosophicalhacker.com/" />
    <meta property="article:published_time" content="2017-01-21T11:20:01-05:00" />

    
    <meta property="article:tag" content="android" />
    
    <meta property="article:tag" content="testing" />
    
    

    <title>Exploiting Android-Specific Seams for Testing and Flexibility &middot; Philosophical Hacker</title>

    
    <meta name="description" content="" />
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://www.philosophicalhacker.com/images/favicon.ico">
	  <link rel="apple-touch-icon" href="https://www.philosophicalhacker.com/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="https://www.philosophicalhacker.com/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="https://www.philosophicalhacker.com/css/nav.css" />
    <link href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,700" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:400,700,700italic,400italic|Open+Sans:700,400|Inconsolata" />

    

    
      
          <link href="https://www.philosophicalhacker.com/index.xml" rel="alternate" type="application/rss+xml" title="Philosophical Hacker" />
      
      
    
    <meta name="generator" content="Hugo 0.40" />

    <link rel="canonical" href="https://www.philosophicalhacker.com/post/exploiting-android-specific-seams-for-testing-and-flexibility/" />
    
  
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-63544399-1', 'auto');
      ga('send', 'pageview');

    </script>
  


    
      
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": 
    },
    "author": {
        "@type": "Person",
        "name": ,
        
        "url": ,
        "sameAs": [
            
            
             
             
             
             
             
            
        ]
    },
    "headline": Exploiting Android-Specific Seams for Testing and Flexibility,
    "name": Exploiting Android-Specific Seams for Testing and Flexibility,
    "wordCount": 1083,
    "timeRequired": "PT6M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": en
    },
    "url": https://www.philosophicalhacker.com/post/exploiting-android-specific-seams-for-testing-and-flexibility/,
    "datePublished": 2017-01-21T11:20Z,
    "dateModified": 2017-01-21T11:20Z,
    
    "keywords": android, testing,
    "description": ,
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": https://www.philosophicalhacker.com/post/exploiting-android-specific-seams-for-testing-and-flexibility/
    }
}
    </script>
    


    

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-63544399-1', 'auto');
      ga('send', 'pageview');

    </script>
    

    
</head>

<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/">Home</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/talk">Talks</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://github.com/kmdupr33">Github</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/note">Notes</a>
            </li>
        
    </ul>
    
    
    <a class="subscribe-button icon-feed" href="https://www.philosophicalhacker.com/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">
  
            <header class="main-header post-head no-cover">
                <nav class="main-nav clearfix">
                      
                    <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a> 
                </nav>
            </header>



            <main class="content" role="main">




                <article class="post post">

                    <header class="post-header">
                        <h1 class="post-title">Exploiting Android-Specific Seams for Testing and Flexibility</h1>

                        <section class="post-meta">
                            
                            <time class="post-date" datetime=" 2017-01-21T11:20:01-05:00 ">
            Jan 21, 2017
          </time>  
                            <span class="post-tag small"><a href="https://www.philosophicalhacker.com/tags/android/">#android</a></span> 
                            <span class="post-tag small"><a href="https://www.philosophicalhacker.com/tags/testing/">#testing</a></span> 
                            <strong>&middot; 6 minute read</strong>
                        </section>
                    </header>

                    <section class="post-content">
                        

<p>As I pointed out throughout my <a href="/post/what-makes-android-apps-testable/">series of posts on writing testable Android applications</a>, the key to writing testable Android apps, is creating and exploiting seams. During these posts, I pointed out two types of seams that are available in any OO programming language and any programming environment. In this post, I want to highlight some Android-specific seams that we can leverage to make our applications more testable and flexible.</p>

<h3 id="manifest-seams">Manifest Seams</h3>

<p>Manifest seams allow you to change a manifest that&rsquo;s used for a particular build variant without editing your main manifest in place. Changing your manifest, of course, results in different behavior for your app. These new behaviors can be used to make your app more testable. To flesh out the concept of a manifest seam, let&rsquo;s look at using manifest seams to set up your app&rsquo;s &ldquo;mock mode.&rdquo;</p>

<p>An application running in mock mode stubs out its interactions with external services for testing purposes.<sup>1</sup> A nice example of mock mode in action is <a href="https://github.com/JakeWharton/u2020">Jake Wharton&rsquo;s u2020 app</a>. In his implementation of mock mode, Wharton uses an object seam, along with dagger, to swap out views within Activities so that in mock mode, the <code>MainActivity</code>&rsquo;s view will contain a debug drawer that can be used to configure the stubbing behavior for the app.</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> MainActivity <span style="color:#fff;font-weight:bold">extends</span> Activity {

  @Inject ViewContainer viewContainer;

  @Override <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> onCreate(Bundle savedInstanceState) {
    <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">onCreate</span>(savedInstanceState);

    <span style="color:#007f7f">//...
</span><span style="color:#007f7f"></span>
    ViewGroup container = viewContainer.<span style="color:#007f7f">forActivity</span>(<span style="color:#fff;font-weight:bold">this</span>);    

    inflater.<span style="color:#007f7f">inflate</span>(R.<span style="color:#007f7f">layout</span>.<span style="color:#007f7f">main_activity</span>, container);
    ButterKnife.<span style="color:#007f7f">bind</span>(<span style="color:#fff;font-weight:bold">this</span>, container);
    <span style="color:#007f7f">//...
</span><span style="color:#007f7f"></span>  }  
}</code></pre></div>

<p>This code gives u2020 users the ability to change mock behavior using the app&rsquo;s UI without having to modify any production code. We could use manifest seams, however, to accomplish the same thing.<sup>2</sup></p>

<p>Manifest seams are made possible via manifest merging and <a href="https://developer.android.com/studio/build/manifest-merge.html#merge_rule_markers">merge rule markers</a>. To exploit a manifest seam for mock mode, we can use merge rule markers to tell the manifest merger to change the initial <code>Activity</code> that&rsquo;s launched for a particular build variant.</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#007f7f">&lt;!-- src/mock/AndroidManifest.xml --&gt;</span>
<span style="font-weight:bold">&lt;activity</span>
  <span style="color:#007f7f">android:name=</span><span style="color:#0ff;font-weight:bold">&#34;.StubConfigActivity&#34;</span><span style="font-weight:bold">&gt;</span>
  <span style="font-weight:bold">&lt;intent-filter&gt;</span>
    <span style="font-weight:bold">&lt;action</span> <span style="color:#007f7f">android:name=</span><span style="color:#0ff;font-weight:bold">&#34;android.intent.action.MAIN&#34;</span><span style="font-weight:bold">/&gt;</span>
    <span style="font-weight:bold">&lt;category</span> <span style="color:#007f7f">android:name=</span><span style="color:#0ff;font-weight:bold">&#34;android.intent.category.LAUNCHER&#34;</span><span style="font-weight:bold">/&gt;</span>
  <span style="font-weight:bold">&lt;/intent-filter&gt;</span>
<span style="font-weight:bold">&lt;/activity&gt;</span>
<span style="font-weight:bold">&lt;activity</span>
  <span style="color:#007f7f">android:name=</span><span style="color:#0ff;font-weight:bold">&#34;.MainActivity&#34;</span><span style="font-weight:bold">&gt;</span>
  <span style="font-weight:bold">&lt;intent-filter</span> <span style="color:#007f7f">tools:node=</span><span style="color:#0ff;font-weight:bold">&#34;remove&#34;</span><span style="font-weight:bold">&gt;</span>
    <span style="font-weight:bold">&lt;action</span> <span style="color:#007f7f">android:name=</span><span style="color:#0ff;font-weight:bold">&#34;android.intent.action.MAIN&#34;</span><span style="font-weight:bold">/&gt;</span>
    <span style="font-weight:bold">&lt;category</span> <span style="color:#007f7f">android:name=</span><span style="color:#0ff;font-weight:bold">&#34;android.intent.category.LAUNCHER&#34;</span><span style="font-weight:bold">/&gt;</span>
  <span style="font-weight:bold">&lt;/intent-filter&gt;</span>
<span style="font-weight:bold">&lt;/activity&gt;</span></code></pre></div>

<p>The resulting manifest for the mock build variant will have the <code>StubConfigActivity</code> as its launching activity, rather than the <code>MainActivity</code>.</p>

<p>I think there are other interesting possibilities here that are worth exploring. For example, you could use merge rule markers to substitute out which actions and categories are on non-launcher <code>Activity</code>&rsquo;s intent-filter and thereby change which activities are started when we call <code>context.startActivity</code> with implicit intents.</p>

<h3 id="buildconfig-seams">BuildConfig Seams</h3>

<p>BuildConfig seams allow us to change the values stored in the <code>BuildConfig</code>&rsquo;s constants depending on which build variant we&rsquo;re building. By default, <code>BuildConfig</code> contains some useful values like, <code>DEBUG</code> and <code>FLAVOR</code>, but we can actually create additional <code>BuildConfig</code> constants via gradle. Let&rsquo;s start by looking a simple example of creating a BuildConfig field:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">productFlavors {
  mock {
    buildConfigField(<span style="color:#0ff;font-weight:bold">&#39;Boolean&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;MOCK&#39;</span>, <span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>)
  }
}</code></pre></div>

<p>A simple use case for BuildConfig seams is setting up the base url for the api your app is hitting. This can make testing easier because you can point your app to a staging, sandbox, mock, or production servers without modifying production code.<sup>3</sup> Leveraging a BuildConfig seam in this way might look something like this:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">defaultConfig {
  buildConfigField(<span style="color:#0ff;font-weight:bold">&#39;String&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;API_BASE&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;\&#34;api.awesomecompany.com\&#34;&#39;</span>)
}
productFlavors {
  sandbox {
    buildConfigField(<span style="color:#0ff;font-weight:bold">&#39;String&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;API_BASE&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;\&#34;localhost:8080\&#34;&#39;</span>)
  }
}</code></pre></div>

<p>You could then use the BuildConfig field like this:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">public</span> String buildGetAwesomenessApiUrl() {
  <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;http://&#34;</span> + BuildConfig.<span style="color:#007f7f">API_BASE</span> + <span style="color:#0ff;font-weight:bold">&#34;/awesomenesss&#34;</span>;
}</code></pre></div>

<p>For those of you who have read <a href="/post/build-variants-and-link-seams/">my post on link seams</a>, BuildConfig seams may just look like a special case of using build variants to create link seams. In some sense, that&rsquo;s true.</p>

<p>However, BuildConfig seams have an advantage over placing identically named files in different sourcesets for different build variants: you can set a BuildConfig field for the default configuration and override it for specific build variants. You can&rsquo;t do this by placing identically named files in the <code>main</code> and build-variant sourcesets folders because the compiler will complain that there&rsquo;s two files with the same name.</p>

<p>There are other things to explore here as well. One use case I&rsquo;ve found for BuildConfig seams is in <em>composing</em> dagger configuration behavior for multi-dimensional product flavors by storing class names in BuildConfig fields and instantiating them via reflection. I&rsquo;m not very confident that this is a sensible way to use BuildConfig seams, but its interesting anyway, and it might serve as a foundation for a better way to use BuildConfig seams.</p>

<h3 id="resource-seams">Resource Seams</h3>

<p>Resources from different build variants, like AndroidManifests, get merged. Unlike manifest merging, we don&rsquo;t have merge rule markers that allow us to tweak how the resources are merged. However, we can still take advantage of the default merge behavior to change the behavior of our apps without editing production code in place. The default merge behavior, according to <a href="https://developer.android.com/studio/write/add-resources.html#resource_merging">the docs</a>, is this:</p>

<p>build variant &gt; build type &gt; product flavor &gt; main source set &gt; library dependencies</p>

<p>This means that we can place resources in the main source set as a kind of default and override them for specific build variants. Again, this is something that we can&rsquo;t do by placing identically named java files in different sourcesets.</p>

<p>BuildConfig seams and Resource seams obviously have some similarities, which makes choosing between them confusing. Off the cuff, we can say that using a BuildConfig field is easier than getting a resource value, so we may want to prefer BuildConfig seams when we don&rsquo;t have access to a <code>Context</code>. Stuffing all of our build variant specific values into a single BuildConfig class, however, isn&rsquo;t going to scale well, so we may want to prefer Resource seams if we do have access to a <code>Context</code>.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Android developers have their own Android-specific seams that they can exploit for testing purposes. Manifest seams rely on manifest merging and merge rule markers. BuildConfig seams rely on the <code>productFlavor.buildConfigField</code> method. Resource seams rely on Android&rsquo;s default the resource merging behavior.</p>

<h3 id="notes">Notes:</h3>

<ol>
<li><p>If you don&rsquo;t know why we&rsquo;d want to do this, <a href="https://android-developers.googleblog.com/2015/12/leveraging-product-flavors-in-android.html">read this</a>.</p></li>

<li><p>Manifest seams may be an inferior way of doing this, as Wharton&rsquo;s strategy allows users to change mock behavior throughout their session with the app, while manifest seams, as we&rsquo;ll see, only allow us to change this behavior when the app is first launched. My purpose here isn&rsquo;t to say which approach is better. Its just to point out that manifest seams exist.</p></li>

<li><p>I haven&rsquo;t found much use for mock web servers. I can eliminate flaky tests without them, and they often slow tests down since the tests are still making network requests.</p></li>
</ol>

                    </section>


                    <footer class="post-footer">


                         
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<div id="mc_embed_signup">
<form action="//appspot.us11.list-manage.com/subscribe/post?u=9612e1a3261cb5689813bf38b&amp;id=0c5f737d6c" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<label for="mce-EMAIL">Subscribe to Philosophical Hacker</label>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9612e1a3261cb5689813bf38b_0c5f737d6c" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>

 
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=Exploiting%20Android-Specific%20Seams%20for%20Testing%20and%20Flexibility&nbsp;-&nbsp;Philosophical%20Hacker&amp;url=https%3a%2f%2fwww.philosophicalhacker.com%2fpost%2fexploiting-android-specific-seams-for-testing-and-flexibility%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.philosophicalhacker.com%2fpost%2fexploiting-android-specific-seams-for-testing-and-flexibility%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-pinterest" style="font-size: 1.4em" href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fwww.philosophicalhacker.com%2fpost%2fexploiting-android-specific-seams-for-testing-and-flexibility%2f&amp;description=Exploiting%20Android-Specific%20Seams%20for%20Testing%20and%20Flexibility"
      onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
      <span class="hidden">Pinterest</span>
  </a>
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=https%3a%2f%2fwww.philosophicalhacker.com%2fpost%2fexploiting-android-specific-seams-for-testing-and-flexibility%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>

 

<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'philosophicalhacker';
  var disqus_url = 'https:\/\/www.philosophicalhacker.com\/post\/exploiting-android-specific-seams-for-testing-and-flexibility\/';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




                    </footer>
                </article>

            </main>

             <aside class="read-next">
  
      <a class="read-next-story" style="background-image: url(https://www.philosophicalhacker.com/images/espresso-beans.jpg)" href="/post/espresso-test-addiction/">
          <section class="post">
              <h2>Espresso Test Addiction: An Anti-pattern</h2>
              
          </section>
      </a>
  
  
      <a class="read-next-story prev" style="background-image: url(https://www.philosophicalhacker.com/images/castle.jpg)" href="/post/tdd-is-greater-than-the-principle-of-single-responsibility/">
          <section class="post">
              <h2>TDD &gt; The Principle of Single Responsibility</h2>
          </section>
      </a>
  
</aside>
  <div class="rc-scout" style="margin-top: 50px; text-align: center;"></div>
<footer class="site-footer clearfix">
    <section class="copyright"><a href="">Philosophical Hacker</a> </section>
    
    <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
    
</footer>
</div>
<script type="text/javascript" src="https://www.philosophicalhacker.com/js/jquery.js"></script>
<script type="text/javascript" src="https://www.philosophicalhacker.com/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="https://www.philosophicalhacker.com/js/index.js"></script>

<script async defer src="https://www.recurse-scout.com/loader.js?t=b7a91d718a76fe21289fbe7d51a58f19"></script>

</body>

</html>