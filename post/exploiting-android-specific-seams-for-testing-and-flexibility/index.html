<!DOCTYPE html>
<html lang="en"><meta charset="utf-8"><meta name="generator" content="Hugo 0.73.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>Exploiting Android-Specific Seams for Testing and Flexibility&nbsp;&ndash;&nbsp;Philosophical Hacker</title><link rel="stylesheet" href="/css/core.min.5cc905347df78a876835000e5fe52ff5a25efea519bc261bf09e8820be0bbb3d9c8b5e67a7fe33e4e63e5b79b3bbba95.css" integrity="sha384-XMkFNH33iodoNQAOX&#43;Uv9aJe/qUZvCYb8J6IIL4Luz2ci15np/4z5OY&#43;W3mzu7qV"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Exploiting Android-Specific Seams for Testing and Flexibility" />
<script type="text/javascript">
  window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=document.createElement("script");r.type="text/javascript",r.async=!0,r.src="https://cdn.heapanalytics.com/js/heap-"+e+".js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(r,a);for(var n=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","resetIdentity","removeEventProperty","setEventProperties","track","unsetEventProperty"],o=0;o<p.length;o++)heap[p[o]]=n(p[o])};
  heap.load("2872977926");
</script>
<body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><span class="site name">Philosophical Hacker</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/about/me">About</a><a class="nav item" href="/talk">Talks</a><a class="nav item" href="https://www%2eoreilly%2ecom/programming/free/rxjava-for-android-app-development%2ecsp?intcmp=il-prog-free-product-na_new_site_rxjava_for_android_app_development"target="_blank">RxJava O&#39;Reilly Book</a><a class="nav item" href="/note">Notes</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">Exploiting Android-Specific Seams for Testing and Flexibility</h1><p class="article date">2017-01-21</p></section><article class="article markdown-body"><p>As I pointed out throughout my <a href="/post/what-makes-android-apps-testable/">series of posts on writing testable Android applications</a>, the key to writing testable Android apps, is creating and exploiting seams. During these posts, I pointed out two types of seams that are available in any OO programming language and any programming environment. In this post, I want to highlight some Android-specific seams that we can leverage to make our applications more testable and flexible.</p>
<h3 id="manifest-seams">Manifest Seams</h3>
<p>Manifest seams allow you to change a manifest that&rsquo;s used for a particular build variant without editing your main manifest in place. Changing your manifest, of course, results in different behavior for your app. These new behaviors can be used to make your app more testable. To flesh out the concept of a manifest seam, let&rsquo;s look at using manifest seams to set up your app&rsquo;s &ldquo;mock mode.&rdquo;</p>
<p>An application running in mock mode stubs out its interactions with external services for testing purposes.<sup>1</sup> A nice example of mock mode in action is <a href="https://github.com/JakeWharton/u2020"target="_blank">Jake Wharton&rsquo;s u2020 app</a>. In his implementation of mock mode, Wharton uses an object seam, along with dagger, to swap out views within Activities so that in mock mode, the <code>MainActivity</code>'s view will contain a debug drawer that can be used to configure the stubbing behavior for the app.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> MainActivity <span style="color:#fff;font-weight:bold">extends</span> Activity {

  @Inject ViewContainer viewContainer;

  @Override <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> onCreate(Bundle savedInstanceState) {
    <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">onCreate</span>(savedInstanceState);

    <span style="color:#007f7f">//...
</span><span style="color:#007f7f"></span>
    ViewGroup container = viewContainer.<span style="color:#007f7f">forActivity</span>(<span style="color:#fff;font-weight:bold">this</span>);    

    inflater.<span style="color:#007f7f">inflate</span>(R.<span style="color:#007f7f">layout</span>.<span style="color:#007f7f">main_activity</span>, container);
    ButterKnife.<span style="color:#007f7f">bind</span>(<span style="color:#fff;font-weight:bold">this</span>, container);
    <span style="color:#007f7f">//...
</span><span style="color:#007f7f"></span>  }  
}</code></pre></div>
<p>This code gives u2020 users the ability to change mock behavior using the app&rsquo;s UI without having to modify any production code. We could use manifest seams, however, to accomplish the same thing.<sup>2</sup></p>
<p>Manifest seams are made possible via manifest merging and <a href="https://developer.android.com/studio/build/manifest-merge.html#merge_rule_markers"target="_blank">merge rule markers</a>. To exploit a manifest seam for mock mode, we can use merge rule markers to tell the manifest merger to change the initial <code>Activity</code> that&rsquo;s launched for a particular build variant.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#007f7f">&lt;!-- src/mock/AndroidManifest.xml --&gt;</span>
<span style="font-weight:bold">&lt;activity</span>
  <span style="color:#007f7f">android:name=</span><span style="color:#0ff;font-weight:bold">&#34;.StubConfigActivity&#34;</span><span style="font-weight:bold">&gt;</span>
  <span style="font-weight:bold">&lt;intent-filter&gt;</span>
    <span style="font-weight:bold">&lt;action</span> <span style="color:#007f7f">android:name=</span><span style="color:#0ff;font-weight:bold">&#34;android.intent.action.MAIN&#34;</span><span style="font-weight:bold">/&gt;</span>
    <span style="font-weight:bold">&lt;category</span> <span style="color:#007f7f">android:name=</span><span style="color:#0ff;font-weight:bold">&#34;android.intent.category.LAUNCHER&#34;</span><span style="font-weight:bold">/&gt;</span>
  <span style="font-weight:bold">&lt;/intent-filter&gt;</span>
<span style="font-weight:bold">&lt;/activity&gt;</span>
<span style="font-weight:bold">&lt;activity</span>
  <span style="color:#007f7f">android:name=</span><span style="color:#0ff;font-weight:bold">&#34;.MainActivity&#34;</span><span style="font-weight:bold">&gt;</span>
  <span style="font-weight:bold">&lt;intent-filter</span> <span style="color:#007f7f">tools:node=</span><span style="color:#0ff;font-weight:bold">&#34;remove&#34;</span><span style="font-weight:bold">&gt;</span>
    <span style="font-weight:bold">&lt;action</span> <span style="color:#007f7f">android:name=</span><span style="color:#0ff;font-weight:bold">&#34;android.intent.action.MAIN&#34;</span><span style="font-weight:bold">/&gt;</span>
    <span style="font-weight:bold">&lt;category</span> <span style="color:#007f7f">android:name=</span><span style="color:#0ff;font-weight:bold">&#34;android.intent.category.LAUNCHER&#34;</span><span style="font-weight:bold">/&gt;</span>
  <span style="font-weight:bold">&lt;/intent-filter&gt;</span>
<span style="font-weight:bold">&lt;/activity&gt;</span></code></pre></div>
<p>The resulting manifest for the mock build variant will have the <code>StubConfigActivity</code> as its launching activity, rather than the <code>MainActivity</code>.</p>
<p>I think there are other interesting possibilities here that are worth exploring. For example, you could use merge rule markers to substitute out which actions and categories are on non-launcher <code>Activity</code>'s intent-filter and thereby change which activities are started when we call <code>context.startActivity</code> with implicit intents.</p>
<h3 id="buildconfig-seams">BuildConfig Seams</h3>
<p>BuildConfig seams allow us to change the values stored in the <code>BuildConfig</code>'s constants depending on which build variant we&rsquo;re building. By default, <code>BuildConfig</code> contains some useful values like, <code>DEBUG</code> and <code>FLAVOR</code>, but we can actually create additional <code>BuildConfig</code> constants via gradle. Let&rsquo;s start by looking a simple example of creating a BuildConfig field:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">productFlavors {
  mock {
    buildConfigField(<span style="color:#0ff;font-weight:bold">&#39;Boolean&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;MOCK&#39;</span>, <span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>)
  }
}</code></pre></div>
<p>A simple use case for BuildConfig seams is setting up the base url for the api your app is hitting. This can make testing easier because you can point your app to a staging, sandbox, mock, or production servers without modifying production code.<sup>3</sup> Leveraging a BuildConfig seam in this way might look something like this:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">defaultConfig {
  buildConfigField(<span style="color:#0ff;font-weight:bold">&#39;String&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;API_BASE&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;\&#34;api.awesomecompany.com\&#34;&#39;</span>)
}
productFlavors {
  sandbox {
    buildConfigField(<span style="color:#0ff;font-weight:bold">&#39;String&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;API_BASE&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;\&#34;localhost:8080\&#34;&#39;</span>)
  }
}</code></pre></div>
<p>You could then use the BuildConfig field like this:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">public</span> String buildGetAwesomenessApiUrl() {
  <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;http://&#34;</span> + BuildConfig.<span style="color:#007f7f">API_BASE</span> + <span style="color:#0ff;font-weight:bold">&#34;/awesomenesss&#34;</span>;
}</code></pre></div>
<p>For those of you who have read <a href="/post/build-variants-and-link-seams/">my post on link seams</a>, BuildConfig seams may just look like a special case of using build variants to create link seams. In some sense, that&rsquo;s true.</p>
<p>However, BuildConfig seams have an advantage over placing identically named files in different sourcesets for different build variants: you can set a BuildConfig field for the default configuration and override it for specific build variants. You can&rsquo;t do this by placing identically named files in the <code>main</code> and build-variant sourcesets folders because the compiler will complain that there&rsquo;s two files with the same name.</p>
<p>There are other things to explore here as well. One use case I&rsquo;ve found for BuildConfig seams is in <em>composing</em> dagger configuration behavior for multi-dimensional product flavors by storing class names in BuildConfig fields and instantiating them via reflection. I&rsquo;m not very confident that this is a sensible way to use BuildConfig seams, but its interesting anyway, and it might serve as a foundation for a better way to use BuildConfig seams.</p>
<h3 id="resource-seams">Resource Seams</h3>
<p>Resources from different build variants, like AndroidManifests, get merged. Unlike manifest merging, we don&rsquo;t have merge rule markers that allow us to tweak how the resources are merged. However, we can still take advantage of the default merge behavior to change the behavior of our apps without editing production code in place. The default merge behavior, according to <a href="https://developer.android.com/studio/write/add-resources.html#resource_merging"target="_blank">the docs</a>, is this:</p>
<p>build variant &gt; build type &gt; product flavor &gt; main source set &gt; library dependencies</p>
<p>This means that we can place resources in the main source set as a kind of default and override them for specific build variants. Again, this is something that we can&rsquo;t do by placing identically named java files in different sourcesets.</p>
<p>BuildConfig seams and Resource seams obviously have some similarities, which makes choosing between them confusing. Off the cuff, we can say that using a BuildConfig field is easier than getting a resource value, so we may want to prefer BuildConfig seams when we don&rsquo;t have access to a <code>Context</code>. Stuffing all of our build variant specific values into a single BuildConfig class, however, isn&rsquo;t going to scale well, so we may want to prefer Resource seams if we do have access to a <code>Context</code>.</p>
<h3 id="conclusion">Conclusion</h3>
<p>Android developers have their own Android-specific seams that they can exploit for testing purposes. Manifest seams rely on manifest merging and merge rule markers. BuildConfig seams rely on the <code>productFlavor.buildConfigField</code> method. Resource seams rely on Android&rsquo;s default the resource merging behavior.</p>
<h3 id="notes">Notes:</h3>
<ol>
<li>
<p>If you don&rsquo;t know why we&rsquo;d want to do this, <a href="https://android-developers.googleblog.com/2015/12/leveraging-product-flavors-in-android.html"target="_blank">read this</a>.</p>
</li>
<li>
<p>Manifest seams may be an inferior way of doing this, as Wharton&rsquo;s strategy allows users to change mock behavior throughout their session with the app, while manifest seams, as we&rsquo;ll see, only allow us to change this behavior when the app is first launched. My purpose here isn&rsquo;t to say which approach is better. Its just to point out that manifest seams exist.</p>
</li>
<li>
<p>I haven&rsquo;t found much use for mock web servers. I can eliminate flaky tests without them, and they often slow tests down since the tests are still making network requests.</p>
</li>
</ol>
</article><section class="article labels"><a class="tag" href=/tags/android/>android</a><a class="tag" href=/tags/testing/>testing</a></section></div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/post/espresso-test-addiction/"><span class="li iconfont icon-article"></span>Espresso Test Addiction: An Anti-pattern</a></p><p><a class="link" href="/post/tdd-is-greater-than-the-principle-of-single-responsibility/"><span class="li iconfont icon-article"></span>TDD > The Principle of Single Responsibility</a></p></section><section class="article discussion"><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "philosophicalhacker" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></section></div></section><section id="footer"><div style="display: flex; flex-direction: row; justify-content: center;">
  <p>
    &copy; 2021 Matt Dupree
  </p>
</div>
</section><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/&#43;DiW/UqRcLbRjq" crossorigin="anonymous"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l&#43;B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd&#43;qj&#43;o24G5ZU2zJz" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
            onload="renderMathInElement(document.body);"></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-63544399-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script src="/js/core.min.e824fe5a8e6cd5e2ac09542506ccf3c3ad34d1f7503ad17867ea48f453c8e1ea9f6dfda7691546f13c99136fd4a9bd13.js" integrity="sha384-6CT&#43;Wo5s1eKsCVQlBszzw6000fdQOtF4Z&#43;pI9FPI4eqfbf2naRVG8TyZE2/Uqb0T"></script></body>

</html>