<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
  />
  <style>
    #content img {
      max-width: 100%;
    }
    #mc_embed_signup label {
      color: white;
    }
    #mc_embed_signup input.email {
      color: white;
      border-color: white;
    }

    #mc_embed_signup input.button {
      background-color: #ee6e73;
    }
    .rc-scout .rc-scout__link:link {
      color: white;
    }
    .browser-default-uls ul {
      padding-left: 30px;
      margin-top: 10px;
      margin-bottom: 15px;
    }
    .browser-default-uls ul > li {
      list-style-type: disc!important;
    }
  </style>
  <title>Philosophical Hacker</title>
</head>
<body><nav>
  <div class="nav-wrapper green">
    <a
      href="/"
      class="brand-logo"
      style="margin-left: 10px;"
      >Philosophical Hacker</a
    >
    <a href="#" data-target="mobile-demo" class="sidenav-trigger"
      ><i class="material-icons">menu</i></a
    >
    <ul class="right hide-on-med-and-down">
      <li><a href="/about/me">About</a></li>
      
      <li><a href="/note">Notes</a></li>
      <li>
        <a
          href="https://www.oreilly.com/library/view/~/9781492048343/?intcmp=il-prog-free-product-na_new_site_rxjava_for_android_app_development"
          >RxJava O'Reilly Ebook</a
        >
      </li>
    </ul>
  </div>
  <ul class="sidenav" id="mobile-demo">
    <li><a href="/about/me">About</a></li>
    
    <li><a href="/note">Notes</a></li>
    <li>
      <a
        href="https://www.oreilly.com/library/view/~/9781492048343/?intcmp=il-prog-free-product-na_new_site_rxjava_for_android_app_development"
        >Rx Java O'Reilly Ebook</a
      >
    </li>
  </ul>
</nav>
<div id="content" class="browser-default-uls">

    <img style="filter: brightness(.4); width: 100%;" src="/images/coffee.jpeg"/>

<div class="row">
  <div class="col s12 m8 offset-m2">
      <section id="main">          
          <h1 id="title">PSA: Dont Use Espresso Idling Resources like Google does</h1>
          <p id="date"> Tue Jun 7, 2016 | 5 Minute read </p>
          <div>
                <article id="content">
                   

<blockquote>
<p>Roman Nurik: &hellip;That&rsquo;s actually one of the harder things with writing good sample code. People are going to be copying and pasting the heck out of it so you can&rsquo;t take those shortcuts that you sometimes hopefully aren&rsquo;t taking.</p>

<p>Chet Haase: I always take the shortcuts. That&rsquo;s one of the more interesting things that the developer relations group does in general&hellip;we will put together tests and sample code for the features that we work but we really don&rsquo;t have the time to dive in deeply and do it in a real context.</p>

<p>Android Developers Backstage, <a href="http://androidbackstage.blogspot.com/2015/04/episode-24-roman-holiday.html">Episode 23</a>, 17:35-18:34</p>
</blockquote>

<p>Google has to put together a series of &ldquo;code labs&rdquo; that are meant to provide a hands on learning experience for grokking Android-related topics. It&rsquo;s been a while since I&rsquo;ve worked seriously on the Android platform, so I thought I&rsquo;d take a look at the code lab on Android testing to see what has changed. (Cause I care <a href="http://www.philosophicalhacker.com/2015/04/10/against-android-unit-tests">about testing</a>.)</p>

<p><a href="https://codelabs.developers.google.com/codelabs/android-testing/index.html?index=..%2F..%2Findex#0">The Android testing code lab</a> walks you through the process of creating tests for a Todo application. One of the features of the todo application is that it shows a list of todos. This feature is implemented by a <code>NotesPresenter</code> class (presenter as in &ldquo;<a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93presenter">Model View Presenter</a>&rdquo;). While I was looking at the testing code lab on testing, I stumbled upon something disturbing within the <code>NotesPresenter</code>:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Override
<span style="color:#fff;font-weight:bold">public</span> void loadNotes(<span style="color:#fff;font-weight:bold">boolean</span> forceUpdate) {    
    <span style="color:#007f7f">//...
</span><span style="color:#007f7f"></span>
    <span style="color:#007f7f">// The network request might be handled in a different thread so make sure Espresso knows
</span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// that the app is busy until the response is handled.
</span><span style="display:block;width:100%;background-color:#191919"><span style="color:#007f7f"></span>    EspressoIdlingResource.<span style="color:#007f7f">increment</span>(); <span style="color:#007f7f">// App is busy until further notice
</span></span><span style="color:#007f7f"></span>
    mNotesRepository.<span style="color:#007f7f">getNotes</span>(<span style="color:#fff;font-weight:bold">new</span> NotesRepository.<span style="color:#007f7f">LoadNotesCallback</span>() {
        @Override
        <span style="color:#fff;font-weight:bold">public</span> void onNotesLoaded(List&lt;Note&gt; notes) {
<span style="display:block;width:100%;background-color:#191919">            EspressoIdlingResource.<span style="color:#007f7f">decrement</span>(); <span style="color:#007f7f">// Set app as idle.
</span></span><span style="color:#007f7f"></span>            mNotesView.<span style="color:#007f7f">setProgressIndicator</span>(<span style="color:#fff;font-weight:bold">false</span>);
            <span style="color:#fff;font-weight:bold">if</span> (notes.<span style="color:#007f7f">isEmpty</span>()) {
                mNotesView.<span style="color:#007f7f">showNotesEmptyPlaceholder</span>();
            } <span style="color:#fff;font-weight:bold">else</span> {
                mNotesView.<span style="color:#007f7f">showNotes</span>(notes);
            }
        }
    });
}</code></pre></div>

<p>This article is about why this code is disturbing and what we can do to fix it. Spoiler: it violates the principle of single responsibility and we can fix it using the dependency injection and decorator patterns.</p>

<h1 id="disturbing">Disturbing</h1>

<p>The comments in the above code definitely help to point out why this is troubling, but if you&rsquo;re not familiar with <code>IdlingResource</code>, you may not immediately see why the problem with this code. <code>IdlingResource</code>s help you write robust functional UI tests with espresso. These tests are &ldquo;robust&rdquo; because you don&rsquo;t need to explicitly tell your tests to &ldquo;sleep&rdquo; for a <em>predetermined</em> amount of time while some asynchronous task completes. <code>IdlingResource</code>s is a way of telling espresso &ldquo;don&rsquo;t do any more assertions because the app is doing something that might affect whether your assertions are satisfied.&rdquo;</p>

<p>For example, suppose we have an espresso test that verifies that the todo notes are displayed after they are loaded and that the progressIndicator in the view is hidden after those notes are loaded:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Test
<span style="color:#fff;font-weight:bold">public</span> void showNotes() <span style="color:#fff;font-weight:bold">throws</span> Exception {
    onView(withId(R.<span style="color:#007f7f">id</span>.<span style="color:#007f7f">progressIndicator</span>)).<span style="color:#007f7f">check</span>(matches(not(isDisplayed())));
    onView(withId(R.<span style="color:#007f7f">id</span>.<span style="color:#007f7f">notes_list</span>)).<span style="color:#007f7f">check</span>(matches(isDisplayed()));
}</code></pre></div>

<p>We don&rsquo;t want this code to immediately assert that the progressIndicator is invisible and the notes list are visible because it takes some time for the notes to load from the network. So, the previous code snippet with an <code>IdlingResource</code> would tell this test that it needs to wait until the notes are loaded from the network before performing this verification.</p>

<p>Let&rsquo;s take a second look at the disturbing code:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Override
<span style="color:#fff;font-weight:bold">public</span> void loadNotes(<span style="color:#fff;font-weight:bold">boolean</span> forceUpdate) {    
    <span style="color:#007f7f">//...
</span><span style="color:#007f7f"></span>
    <span style="color:#007f7f">// The network request might be handled in a different thread so make sure Espresso knows
</span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// that the app is busy until the response is handled.
</span><span style="display:block;width:100%;background-color:#191919"><span style="color:#007f7f"></span>    EspressoIdlingResource.<span style="color:#007f7f">increment</span>(); <span style="color:#007f7f">// App is busy until further notice
</span></span><span style="color:#007f7f"></span>
    mNotesRepository.<span style="color:#007f7f">getNotes</span>(<span style="color:#fff;font-weight:bold">new</span> NotesRepository.<span style="color:#007f7f">LoadNotesCallback</span>() {
        @Override
        <span style="color:#fff;font-weight:bold">public</span> void onNotesLoaded(List&lt;Note&gt; notes) {
<span style="display:block;width:100%;background-color:#191919">            EspressoIdlingResource.<span style="color:#007f7f">decrement</span>(); <span style="color:#007f7f">// Set app as idle.
</span></span><span style="color:#007f7f"></span>            mNotesView.<span style="color:#007f7f">setProgressIndicator</span>(<span style="color:#fff;font-weight:bold">false</span>);
            <span style="color:#fff;font-weight:bold">if</span> (notes.<span style="color:#007f7f">isEmpty</span>()) {
                mNotesView.<span style="color:#007f7f">showNotesEmptyPlaceholder</span>();
            } <span style="color:#fff;font-weight:bold">else</span> {
                mNotesView.<span style="color:#007f7f">showNotes</span>(notes);
            }
        }
    });
}</code></pre></div>

<p>We can now quickly say what&rsquo;s disturbing about this: this presenter violates the principle of single responsibility. More than that: it violates the principle in a particularly egregious way: it mixes <em>application</em> responsibilities with <em>testing</em> responsibilities. This is silly. Don&rsquo;t do this. Violating the principle of single responsibility is a sure-fire way to create spaghetti code and spaghetti doesn&rsquo;t look as good in code as it does on a plate.</p>

<p><img src="/images/spaghetti.jpeg" alt="spaghetti on a plate" /></p>

<h1 id="fixit">Fixit</h1>

<p>Instead of mixing responsibilities, register your <code>IdlingResource</code> in your tests-related code, where test-related responsibilities belong. One way to do this is the use dependency injection and decorators. The code lab project already has a limited dependency injection mechanism, so we can just use that. The project has a dependency injector that&rsquo;s specifically used for testing called <code>Injection.</code> All we need to do is decorate the <code>NotesRepository</code> that&rsquo;s injected by the <code>Injection</code> class, and we have what we need to avoid mixing responsibilities:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">public</span> static NotesRepository provideNotesRepository() {
    <span style="color:#fff;font-weight:bold">final</span> NotesRepository inMemoryRepoInstance
      = NoteRepositories.<span style="color:#007f7f">getInMemoryRepoInstance</span>(<span style="color:#fff;font-weight:bold">new</span> FakeNotesServiceApiImpl());
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> NotesRepository() {
        @Override
        <span style="color:#fff;font-weight:bold">public</span> void getNotes(@NonNull <span style="color:#fff;font-weight:bold">final</span> LoadNotesCallback callback) {
            EspressoIdlingResource.<span style="color:#007f7f">increment</span>();
            inMemoryRepoInstance.<span style="color:#007f7f">getNotes</span>(<span style="color:#fff;font-weight:bold">new</span> LoadNotesCallback() {
                @Override
                <span style="color:#fff;font-weight:bold">public</span> void onNotesLoaded(List&lt;Note&gt; notes) {
                    EspressoIdlingResource.<span style="color:#007f7f">decrement</span>();
                    callback.<span style="color:#007f7f">onNotesLoaded</span>(notes);
                }
            });
        }

        <span style="color:#007f7f">//...
</span><span style="color:#007f7f"></span>    };
}</code></pre></div>

<p>The <code>NotesRepository</code> returned by this method gets injected into the <code>Presenter</code> here:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">public</span> class NotesFragment extends Fragment implements NotesContract.<span style="color:#007f7f">View</span> {
    <span style="color:#007f7f">//...
</span><span style="color:#007f7f"></span>    @Override
    <span style="color:#fff;font-weight:bold">public</span> void onCreate(@Nullable Bundle savedInstanceState) {
        <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">onCreate</span>(savedInstanceState);
        /...
<span style="display:block;width:100%;background-color:#191919">        mActionsListener
</span><span style="display:block;width:100%;background-color:#191919">          = <span style="color:#fff;font-weight:bold">new</span> NotesPresenter(Injection.<span style="color:#007f7f">provideNotesRepository</span>(), <span style="color:#fff;font-weight:bold">this</span>);
</span>    }
}</code></pre></div>

<p>Voila. And now your espresso tests will wait until the notes have been loaded before asserting the view state and you&rsquo;ve avoided mixing testing responsibilities with your business logic. Bon Appetite.</p>

                </article>
          </div>
        </section>                
  </div>
  
</div>
<footer class="page-footer green text-white">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
            
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<div id="mc_embed_signup">
<form action="//appspot.us11.list-manage.com/subscribe/post?u=9612e1a3261cb5689813bf38b&amp;id=0c5f737d6c" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<label for="mce-EMAIL">Get Email Updates</label>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9612e1a3261cb5689813bf38b_0c5f737d6c" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>


            <div class="rc-scout" style="text-align: center;"></div>    
        </div>
        <aside id="meta">            
            <div>
                
                <div>                  
                  <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/post/process-vs-procedure-recursion/">Previous: Process vs. Procedure Recursion</a>
                </div>
                
                
                <div>                  
                  <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/post/react-and-redux-like-architectures-for-android/">Next: How React-and-Redux-like Architectures for Android can make Testing Easier</a>
                </div>
                
            </div>
        </aside>  
        <div class="col l4 offset-l2 s12">
          <h5 class="white-text">Tags</h5>
          <ul>              
              
              <ul id="tags">
                
                  <li> <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/tags/android">android</a> </li>
                
                  <li> <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/tags/testing">testing</a> </li>
                
              </ul>
                          
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-copyright">
      <div class="container">
      Â© 2019 Matt Dupree
      </div>
    </div>    
  </footer>        


        </div><script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var elems = document.querySelectorAll(".sidenav");
    var instances = M.Sidenav.init(elems, {});
  });
</script>
<script async defer src="https://www.recurse-scout.com/loader.js?t=b7a91d718a76fe21289fbe7d51a58f19"></script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-63544399-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>
</html>
