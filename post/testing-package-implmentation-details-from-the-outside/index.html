<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8" />
  <meta
    name="description"
    content=""
  />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
  />
  <link href="/css/all.min.css" rel="stylesheet" />
  <style>
    #content {
      font-size: 18px;
      line-height: 1.7;
    }
    #content img {
      max-width: 100%;
    }
    #mc_embed_signup label {
      color: white;
    }
    #mc_embed_signup input.email {
      color: white;
      border-color: white;
    }

    #mc_embed_signup input.button {
      background-color: #ee6e73;
    }
    .rc-scout .rc-scout__link:link {
      color: white;
    }
    .browser-default-uls ul {
      padding-left: 30px;
      margin-top: 10px;
      margin-bottom: 15px;
    }
    .browser-default-uls ul > li {
      list-style-type: disc !important;
    }
    pre {
      overflow: auto;
      padding: 15px;
    }
  </style>
  <title>Philosophical Hacker</title>
</head>
<body><nav>
  <div class="nav-wrapper green">
    <a
      href="/"
      class="brand-logo"
      style="margin-left: 10px;"
      >Philosophical Hacker</a
    >
    <a href="#" data-target="mobile-demo" class="sidenav-trigger"
      ><i class="material-icons">menu</i></a
    >
    <ul class="right hide-on-med-and-down">      
      <li><a href="/about/me">About</a></li>
      
      <li><a href="/note">Notes</a></li>
      <li>
        <a
          href="https://www.oreilly.com/library/view/~/9781492048343/?intcmp=il-prog-free-product-na_new_site_rxjava_for_android_app_development"
          >RxJava O'Reilly Ebook</a
        >
      </li>
      <li>
          <a href="https://twitter.com/philosohacker"
            ><i class="fab fa-twitter"></i
          ></a>
        </li>
        <li>
          <a href="https://www.linkedin.com/in/k-matthew-dupree-44672178/"
            ><i class="fab fa-linkedin-in"></i
          ></a>
        </li>
    </ul>
  </div>
  <ul class="sidenav" id="mobile-demo">    
    <li><a href="/about/me">About</a></li>
    
    <li><a href="/note">Notes</a></li>
    <li>
      <a
        href="https://www.oreilly.com/library/view/~/9781492048343/?intcmp=il-prog-free-product-na_new_site_rxjava_for_android_app_development"
        >Rx Java O'Reilly Ebook</a
      >
    </li>
    <li>
        <a href="https://twitter.com/philosohacker"
          ><i class="fab fa-twitter"></i
        ></a>
      </li>
      <li>
        <a href="https://www.linkedin.com/in/k-matthew-dupree-44672178/"
          ><i class="fab fa-linkedin-in"></i
        ></a>
      </li>
  </ul>
</nav>
<div id="content" class="browser-default-uls">

<div class="row">
  <div class="col s12 m6 offset-m3">
      <section id="main">          
          <h1 id="title">Testing Package Implementation from &#39;the Outside&#39;</h1>
          <p id="date"> Wed Feb 3, 2016 | 3 Minute read </p>
          <div>
                <article id="content">
                   

<p>Sometimes you need to test a package&rsquo;s implementation from outside of the package containing the implementation you&rsquo;d like to test. This post briefly covers why this need arises and how we can meet  that need. Much of the information here is already covered in Andrew Gerrand&rsquo;s <a href="https://www.youtube.com/watch?v=ndmB0bj7eyw">testing techniques talk</a>, so if you&rsquo;ve watched that, you&rsquo;ll probably only think the last section of this post is interesting.</p>

<h3 id="why">Why?</h3>

<p>Like I just said, sometimes you need to test a package&rsquo;s implementation from outside of the package containing the implementation you&rsquo;d like to test. Typically, this situation happens because of circular dependency.</p>

<p>For example, because the testing package depends on the fmt package, the standard library authors couldn&rsquo;t place the tests for the fmt package within the fmt package itself without introducing a circular dependency. To avoid this circular dependency, the fmt tests are actually located in the fmt_test package.</p>

<p>Don&rsquo;t believe me? Have <a href="https://github.com/golang/go/blob/master/src/fmt/fmt_test.go">a look</a>.</p>

<p>Here&rsquo;s another example: as I said in <a href="http://www.philosophicalhacker.com/post/getting-started-with-gomock/">my post on gomock</a>, you can often wind up with circular dependencies while using gomock. You&rsquo;re tests will depend on the package containing your mocks and your mocks will depend on the package containing the interfaces it mocks. If your tests are in the same package as the code you&rsquo;re mocking, then you&rsquo;ll introduce a circular dependency between package containing the code you want to test and the package containing your mocks. Again, the solution here is to move your tests outside of the package containing the code you want to test.</p>

<p>Although the tests are outside of the package you are testing, you may still want to test the implementation details of that package. In other words, you may want to test parts of that package&rsquo;s un-exported interface. For example, the authors of the standard library wanted to test the <code>isSpace()</code> function from the fmt package.</p>

<h3 id="how">How</h3>

<p>In order to test the <code>isSpace()</code> function from outside of the fmt package, the standard lib authors created a export_test.go file in the fmt package. This file simply exports the parts of the un-exported interface that they wanted to test:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007f7f">//export_test.go
</span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">package</span> fmt

<span style="color:#fff;font-weight:bold">var</span> IsSpace = isSpace</code></pre></div>

<p>This file ensures that the <code>isSpace()</code> function is available to the fmt tests as <code>IsSpace()</code>. Importantly, because this file has a _test.go prefix, it is only compiled when the <code>go test</code> command is run, thereby ensuring that no clients outside of the testing package can access the <code>isSpace()</code> function.</p>

<p>Sometimes, however, we want to test more than just an un-exported function from a package. Sometimes, we may want to test the methods of an un-exported struct. Say you&rsquo;ve got a struct like <code>lruCache</code>:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007f7f">//cache.go
</span><span style="color:#007f7f"></span>
<span style="color:#fff;font-weight:bold">type</span> lruCache <span style="color:#fff;font-weight:bold">struct</span> {
	<span style="color:#007f7f">//...
</span><span style="color:#007f7f"></span>}

<span style="color:#fff;font-weight:bold">func</span> (s *lruCache) GetGopher(name <span style="color:#fff;font-weight:bold">string</span>) (Gopher, <span style="color:#fff;font-weight:bold">error</span>) {
	gopher, ok := s.CachedGophers[name]
	<span style="color:#fff;font-weight:bold">if</span> !ok {
		<span style="color:#fff;font-weight:bold">return</span> s.GopherFinder.Find(name)
	}
	<span style="color:#fff;font-weight:bold">return</span> gopher, <span style="color:#fff;font-weight:bold">nil</span>
}

Now, suppose you wanted to test the <span style="color:#0ff;font-weight:bold">`GetGopher()`</span> method. This can be accomplished by combining the above technique with <span style="color:#fff;font-weight:bold">struct</span> embedding:</code></pre></div>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007f7f">//export_test.go
</span><span style="color:#007f7f"></span>
<span style="color:#fff;font-weight:bold">type</span> LRUCache <span style="color:#fff;font-weight:bold">struct</span> {
	lruCache
}</code></pre></div>

<p>Now, in order for this to work, the <code>GetGopher()</code> method has to be exported. This doesn&rsquo;t break encapsulation, however, because an exported method on an un-exported type will still be unaccessible to clients outside of the package.</p>

<h3 id="conclusion">Conclusion</h3>

<p>You just learned how to test package implementation details from &ldquo;the outside.&rdquo; This will come in handy when you break a circular dependency between your test code and the package you&rsquo;re testing by placing the test code outside of the package you&rsquo;re testing.</p>

<p>You&rsquo;re welcome.</p>

                </article>
          </div>
        </section>                
  </div>
  
</div>
<footer class="page-footer green text-white">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
            
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<div id="mc_embed_signup">
<form action="//appspot.us11.list-manage.com/subscribe/post?u=9612e1a3261cb5689813bf38b&amp;id=0c5f737d6c" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<label for="mce-EMAIL">Get Email Updates</label>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9612e1a3261cb5689813bf38b_0c5f737d6c" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>


            <div class="rc-scout" style="text-align: center;"></div>    
        </div>
        <aside id="meta">            
            <div>
                
                <div>                  
                  <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/post/table-driven-tests-with-gomock/">Previous: Table-driven tests with Gomock</a>
                </div>
                
                
                <div>                  
                  <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/post/sicp-111-117/">Next: Sicp 1.1.1-1.1.7</a>
                </div>
                
            </div>
        </aside>  
        <div class="col l4 offset-l2 s12">
          <h5 class="white-text">Tags</h5>
          <ul>              
              
              <ul id="tags">
                
                  <li> <a class="grey-text text-lighten-3" href="https://www.philosophicalhacker.com/tags/go">go</a> </li>
                
              </ul>
                          
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-copyright">
      <div class="container">
      © 2019 Matt Dupree
      </div>
    </div>    
  </footer>        


        </div><script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var elems = document.querySelectorAll(".sidenav");
    var instances = M.Sidenav.init(elems, {});
  });
</script>
<script async defer src="https://www.recurse-scout.com/loader.js?t=b7a91d718a76fe21289fbe7d51a58f19"></script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-63544399-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>
</html>
